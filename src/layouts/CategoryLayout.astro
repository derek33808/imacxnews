---
import Layout from './Layout.astro';
import ArticleCard from '../components/ui/ArticleCard.astro';
import VideoArticleCard from '../components/ui/VideoArticleCard.astro';
import { getCategoryById } from '../data/categories';

const { category, articles } = Astro.props;
const categoryInfo = getCategoryById(category) || { id: category, name: String(category || 'News'), description: '' };

const title = `${categoryInfo.name} News | GlobalNews`;
const description = categoryInfo.description;

// ğŸ¬ YouTube/Vimeo URLæ£€æµ‹å’Œè½¬æ¢å‡½æ•°
function isEmbeddableVideo(url: string): boolean {
  if (!url) return false;
  try {
    const hostname = new URL(url.includes('http') ? url : 'https://' + url).hostname.toLowerCase();
    return hostname.includes('youtube.com') || hostname.includes('youtu.be') || hostname.includes('vimeo.com');
  } catch {
    return false;
  }
}

function convertToEmbedUrl(url: string): string {
  try {
    let videoUrl = url.trim();
    if (!videoUrl.match(/^https?:\/\//)) {
      videoUrl = 'https://' + videoUrl;
    }
    
    const parsedUrl = new URL(videoUrl);
    const hostname = parsedUrl.hostname.toLowerCase();
    
    // YouTube URLs
    if (hostname.includes('youtube.com') || hostname.includes('youtu.be')) {
      let videoId;
      
      if (hostname.includes('youtu.be')) {
        videoId = parsedUrl.pathname.slice(1);
      } else if (parsedUrl.searchParams.has('v')) {
        videoId = parsedUrl.searchParams.get('v');
      } else {
        const match = parsedUrl.pathname.match(/\/embed\/([^/?]+)/);
        if (match) videoId = match[1];
      }
      
      if (videoId) {
        return `https://www.youtube.com/embed/${videoId}`;
      }
    }
    
    // Vimeo URLs
    if (hostname.includes('vimeo.com')) {
      const match = parsedUrl.pathname.match(/\/(\d+)/);
      if (match) {
        return `https://player.vimeo.com/video/${match[1]}`;
      }
    }
    
    return url; // Return original if conversion fails
  } catch (error) {
    console.warn('Failed to convert video URL:', error);
    return url;
  }
}

// ğŸ•’ Format video duration
function formatDuration(seconds: number): string {
  if (!seconds || seconds <= 0) return '0:00';
  const minutes = Math.floor(seconds / 60);
  const secs = Math.floor(seconds % 60);
  return `${minutes}:${secs.toString().padStart(2, '0')}`;
}

// ğŸ¬ Extract YouTube video ID from URL
function getYouTubeVideoId(url: string): string | null {
  try {
    let videoUrl = url.trim();
    if (!videoUrl.match(/^https?:\/\//)) {
      videoUrl = 'https://' + videoUrl;
    }
    
    const parsedUrl = new URL(videoUrl);
    const hostname = parsedUrl.hostname.toLowerCase();
    
    if (hostname.includes('youtube.com') || hostname.includes('youtu.be')) {
      let videoId;
      
      if (hostname.includes('youtu.be')) {
        videoId = parsedUrl.pathname.slice(1);
      } else if (parsedUrl.searchParams.has('v')) {
        videoId = parsedUrl.searchParams.get('v');
      } else {
        const match = parsedUrl.pathname.match(/\/embed\/([^/?]+)/);
        if (match) videoId = match[1];
      }
      
      return videoId;
    }
    
    return null;
  } catch (error) {
    console.warn('Failed to extract YouTube video ID:', error);
    return null;
  }
}

// ğŸ¬ Get YouTube thumbnail URL
function getYouTubeThumbnail(url: string, quality: string = 'maxresdefault'): string | null {
  const videoId = getYouTubeVideoId(url);
  if (!videoId) return null;
  
  // YouTubeç¼©ç•¥å›¾è´¨é‡é€‰é¡¹:
  // maxresdefault: 1280x720 (æœ€é«˜è´¨é‡)
  // hqdefault: 480x360 (é«˜è´¨é‡)
  // mqdefault: 320x180 (ä¸­ç­‰è´¨é‡)
  // default: 120x90 (é»˜è®¤è´¨é‡)
  return `https://img.youtube.com/vi/${videoId}/${quality}.jpg`;
}
---

<Layout title={title} description={description}>
  <div class="container">
    <header class="category-header">
      <h1 class="category-title">{categoryInfo.name}</h1>
      <p class="category-description">{categoryInfo.description}</p>
    </header>
    
    <div class="articles-list" id="categoryArticlesList">
      {/** @type {any[]} */ (articles as any[]).map((article: any, index: number) => (
        <div class="large-article-card">
          <div class="article-media-container">
            {article.mediaType === 'VIDEO' && article.videoUrl ? (
              <div class="article-video-wrapper">
                {isEmbeddableVideo(article.videoUrl) ? (
                  // ğŸ¬ YouTube/Vimeo iframeåµŒå…¥
                  <div class="video-iframe-container">
                    <iframe 
                      src={convertToEmbedUrl(article.videoUrl)}
                      class="article-video-iframe"
                      width="800"
                      height="450"
                      frameborder="0"
                      allowfullscreen
                      allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                      title={article.title}
                    ></iframe>
                    <div class="video-type-badge enhanced">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="white" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M23 7l-7 5 7 5z"/>
                        <rect x="1" y="5" width="15" height="14" rx="2" ry="2"/>
                      </svg>
                      <span>YOUTUBE</span>
                    </div>
                    {article.videoDuration && (
                      <div class="video-duration-badge-top-right">
                        {formatDuration(article.videoDuration)}
                      </div>
                    )}
                  </div>
                ) : (
                  // ğŸ¥ ç›´æ¥è§†é¢‘æ–‡ä»¶æ’­æ”¾
                  <div class="direct-video-container">
                    <video 
                      controls 
                      poster={article.videoPoster || article.image || '/images/placeholder.svg'}
                      preload="metadata"
                      playsinline
                      class="article-video"
                      width="800"
                      height="450"
                    >
                      <source src={article.videoUrl} type="video/mp4">
                      <source src={article.videoUrl} type="video/webm">
                      <source src={article.videoUrl} type="video/ogg">
                      Your browser does not support the video tag.
                    </video>
                    <div class="video-type-badge dynamic-video-badge">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M23 7l-7 5 7 5z"/>
                        <rect x="1" y="5" width="15" height="14" rx="2" ry="2"/>
                      </svg>
                      VIDEO
                    </div>
                    {article.videoDuration && (
                      <div class="video-duration-badge">
                        {formatDuration(article.videoDuration)}
                      </div>
                    )}
                  </div>
                )}
              </div>
            ) : (
              <img 
                src={article.mediaType === 'VIDEO' && isEmbeddableVideo(article.videoUrl) 
                     ? (getYouTubeThumbnail(article.videoUrl) || article.videoPoster || article.image || '/images/placeholder.svg')
                     : (article.mediaType === 'VIDEO' 
                        ? (article.videoPoster || article.image || '/images/placeholder.svg')
                        : article.image)} 
                alt={article.title}
                class="article-image"
                data-article-id={article.id}
                data-video-url={article.mediaType === 'VIDEO' && article.videoUrl ? article.videoUrl : ''}
                data-needs-thumbnail={article.mediaType === 'VIDEO' && !isEmbeddableVideo(article.videoUrl) && !article.videoPoster && !article.image ? 'true' : 'false'}
                loading="lazy"
                width="800"
                height="450"
              />
            )}
          </div>
          
          <div class="article-content">
            <div class="article-meta">
              <a href={`/category/${article.category}`} class={`category-tag ${article.category}`}>
                {article.category === 'TodayNews' ? 'Today News' : 'Past News'}
              </a>
              <span class="publish-date">{new Date(article.publishDate).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' })}</span>
            </div>
            
            <h2 class="article-title">
              <a href={`/article/${article.slug}`}>{article.title}</a>
            </h2>
            
            <p class="article-excerpt">{article.excerpt}</p>
            
            <div class="article-footer">
              <span class="author">By {article.author}</span>
              <a href={`/article/${article.slug}`} class="read-more-btn">
                {article.mediaType === 'VIDEO' ? 'Watch Video' : 'Read more'}
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><path d="M12 5l7 7-7 7"></path></svg>
              </a>
            </div>
          </div>
        </div>
      ))}
    </div>
  </div>
</Layout>

<!-- Client-side script disabled to prevent content jumping -->
<!-- Script moved to external file if needed in future -->

<style>
  /* é…åˆ Layout.astro çš„ Sticky Footer å¸ƒå±€ */
  .container {
    display: flex;
    flex-direction: column;
    flex: 1; /* è®©å®¹å™¨å¡«å…… main çš„å…¨éƒ¨ç©ºé—´ï¼Œé…åˆ Footer margin-top: auto */
    /* ç§»é™¤å›ºå®šmin-heightï¼Œè®©JavaScriptåŠ¨æ€å¤„ç†å¸ƒå±€ */
  }

  .category-header {
    margin: var(--space-8) 0;
    padding-bottom: var(--space-4);
    border-bottom: 1px solid var(--color-border);
    flex-shrink: 0; /* é˜²æ­¢å¤´éƒ¨åŒºåŸŸè¢«å‹ç¼© */
  }
  
  .category-title {
    font-size: 2.5rem;
    margin-bottom: var(--space-2);
    position: relative;
    display: inline-block;
  }
  
  .category-title::after {
    content: '';
    position: absolute;
    bottom: -8px;
    left: 0;
    width: 60px;
    height: 4px;
    background-color: var(--color-primary);
  }
  
  .category-description {
    color: var(--color-text-light);
    font-size: 1.125rem;
    max-width: 800px;
    margin-top: var(--space-4);
  }
  
  .articles-list {
    display: flex;
    flex-direction: column;
    gap: var(--space-8);
    margin-top: var(--space-6);
    width: 100%;
    flex: 1; /* å…³é”®ï¼šè®©æ–‡ç« åˆ—è¡¨åŒºåŸŸå¡«å……å‰©ä½™ç©ºé—´ */
    /* ç§»é™¤å›ºå®šmin-heightï¼Œè®©JavaScriptåŠ¨æ€å¤„ç†sticky footer */
  }

  /* ç®€åŒ–ï¼šåªè®¾ç½®å½“å‰é¡µé¢çš„ç‰¹å®šæ ·å¼ */
  .articles-list {
    flex: 1; /* å…³é”®ï¼šè®©æ–‡ç« åˆ—è¡¨å¡«å……å‰©ä½™ç©ºé—´ */
  }

  :global(#categoryArticlesList .large-article-card) {
    background: var(--color-background);
    border-radius: var(--radius-lg);
    overflow: visible;
    box-shadow: var(--shadow-sm);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    border: 1px solid var(--color-border);
  }

  :global(#categoryArticlesList .large-article-card:hover) {
    transform: translateY(-4px);
    box-shadow: var(--shadow-lg);
  }

  :global(#categoryArticlesList .article-media-container) {
    width: 100%;
    aspect-ratio: 16 / 9;
    overflow: hidden;
    position: relative;
    border-radius: var(--radius-lg) var(--radius-lg) 0 0;
  }

  :global(#categoryArticlesList .article-image) {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.3s ease;
  }

  :global(#categoryArticlesList .article-video-wrapper) {
    position: relative;
    width: 100%;
    height: 100%;
  }

  :global(#categoryArticlesList .article-video) {
    width: 100%;
    height: 100%;
    object-fit: cover;
    background: #000;
  }

  /* ğŸ¬ YouTube iframe æ ·å¼ */
  :global(#categoryArticlesList .video-iframe-container) {
    position: relative;
    width: 100%;
    height: 100%;
    background: #000;
  }

  :global(#categoryArticlesList .article-video-iframe) {
    width: 100%;
    height: 100%;
    border: none;
    background: #000;
  }

  /* ğŸ¥ ç›´æ¥è§†é¢‘å®¹å™¨æ ·å¼ */
  :global(#categoryArticlesList .direct-video-container) {
    position: relative;
    width: 100%;
    height: 100%;
  }

  :global(#categoryArticlesList .video-type-badge) {
    position: absolute;
    top: 12px;
    left: 12px;
    background: rgba(139, 92, 246, 0.9);
    color: white;
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 0.8rem;
    font-weight: 600;
    z-index: 2;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  :global(#categoryArticlesList .video-type-badge svg) {
    color: white;
    flex-shrink: 0;
  }

  /* ğŸ¯ å¢å¼ºçš„YouTubeæ ‡è¯†æ ·å¼ */
  :global(#categoryArticlesList .video-type-badge.enhanced) {
    background: rgba(0, 0, 0, 0.8);
    border: 2px solid white;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    backdrop-filter: blur(10px);
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    animation: youtube-badge-glow 2s infinite;
  }

  :global(#categoryArticlesList .video-type-badge.enhanced svg) {
    color: white !important;
    fill: white !important;
    stroke: white !important;
  }

  :global(#categoryArticlesList .video-type-badge.enhanced span) {
    color: white !important;
    font-weight: 700;
  }

  @keyframes youtube-badge-glow {
    0%, 100% { 
      border-color: white;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }
    50% { 
      border-color: white;
      box-shadow: 0 4px 16px rgba(255, 255, 255, 0.3), 0 2px 8px rgba(0, 0, 0, 0.3);
    }
  }

  :global(#categoryArticlesList .video-duration-badge) {
    position: absolute;
    bottom: 12px;
    right: 12px;
    background: rgba(0, 0, 0, 0.8);
    color: white;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.8rem;
    font-weight: 500;
    z-index: 2;
    display: block;
  }

  /* ğŸ•’ å³ä¸Šè§’YouTubeæ—¶é•¿æ˜¾ç¤º - ä¸å·¦ä¸Šè§’YouTubeæ ‡è¯†å½¢æˆè§†è§‰å¹³è¡¡ */
  :global(#categoryArticlesList .video-duration-badge-top-right) {
    position: absolute;
    top: 12px;
    right: 12px;
    background: rgba(0, 0, 0, 0.8);
    border: 2px solid white;
    color: white;
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 0.8rem;
    font-weight: 700;
    z-index: 3;
    display: flex;
    align-items: center;
    gap: 4px;
    backdrop-filter: blur(10px);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    letter-spacing: 0.5px;
    text-transform: uppercase;
  }


  :global(#categoryArticlesList .large-article-card:hover .article-image) {
    transform: scale(1.05);
  }

  :global(#categoryArticlesList .article-content) {
    padding: var(--space-6);
  }

  :global(#categoryArticlesList .article-meta) {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-4);
    font-size: 0.875rem;
  }

  :global(#categoryArticlesList .publish-date) {
    color: var(--color-text-light);
  }

  :global(#categoryArticlesList .article-title) {
    font-size: 1.75rem;
    font-weight: 700;
    line-height: 1.3;
    margin-bottom: var(--space-4);
  }

  :global(#categoryArticlesList .article-title a) {
    color: var(--color-text);
    text-decoration: none;
    transition: color 0.3s ease;
  }

  :global(#categoryArticlesList .article-title a:hover) {
    color: var(--color-primary);
  }

  :global(#categoryArticlesList .article-excerpt) {
    font-size: 1.125rem;
    line-height: 1.6;
    color: var(--color-text-light);
    margin-bottom: var(--space-6);
  }

  :global(#categoryArticlesList .article-footer) {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-top: var(--space-4);
    border-top: 1px solid var(--color-border);
  }

  :global(#categoryArticlesList .author) {
    font-weight: 500;
    color: var(--color-text-light);
  }

  :global(#categoryArticlesList .read-more-btn) {
    display: flex;
    align-items: center;
    gap: var(--space-1);
    color: var(--color-primary);
    font-weight: 500;
    text-decoration: none;
    transition: gap var(--transition);
    font-size: 0.875rem;
  }

  :global(#categoryArticlesList .read-more-btn:hover) {
    gap: var(--space-2);
  }

  :global(#categoryArticlesList .no-articles) {
    text-align: center;
    padding: var(--space-8);
    color: var(--color-text-light);
    font-size: 1.125rem;
  }
  
  /* ğŸ•’ ç§»åŠ¨ç«¯é€‚é… - è°ƒæ•´å³ä¸Šè§’æ—¶é•¿æ˜¾ç¤ºä½ç½®å’Œå¤§å° */
  @media (max-width: 768px) {
    .container {
      flex: 1; /* ç§»åŠ¨ç«¯ä¿æŒä¸€è‡´çš„ flex è®¾ç½® */
      /* ç§»é™¤ min-height è®¾ç½®ï¼Œè®©å†…å®¹è‡ªç„¶æ‰©å±•ï¼Œé¿å…å­æ»šåŠ¨æ¡ */
    }
    
    .category-header {
      margin: var(--space-6) 0; /* ç§»åŠ¨ç«¯å‡å°‘é—´è· */
    }
    
    .category-title {
      font-size: 2rem;
    }
    
    .articles-list {
      /* åŠ¨æ€è®¡ç®—æœ€å°é«˜åº¦ï¼Œç”±JavaScriptè®¾ç½® */
    }
    
    :global(#categoryArticlesList .article-title) {
      font-size: 1.5rem;
    }
    
    :global(#categoryArticlesList .article-excerpt) {
      font-size: 1rem;
    }
    
    :global(#categoryArticlesList .article-footer) {
      flex-direction: column;
      align-items: flex-start;
      gap: var(--space-3);
    }
    
    :global(#categoryArticlesList .read-more-btn) {
      align-self: flex-start;
    }

  /* ğŸ“± ç§»åŠ¨ç«¯æ—¶é•¿æ˜¾ç¤ºé€‚é… */
  :global(#categoryArticlesList .video-duration-badge-top-right) {
    top: 8px;
    right: 8px;
    padding: 4px 8px;
    font-size: 0.7rem;
    border-width: 1px;
  }

  /* ğŸ¬ VIDEOæ ‡ç­¾åŠ¨æ€éšè—æ ·å¼ */
  :global(.video-type-badge.dynamic-video-badge) {
    position: absolute;
    top: 12px;
    left: 12px;
    background: rgba(139, 92, 246, 0.9);
    color: white;
    padding: 6px 10px;
    border-radius: 8px;
    font-size: 0.75rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 4px;
    backdrop-filter: blur(8px);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    z-index: 10;
    transition: opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1), transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    pointer-events: none; /* é»˜è®¤å…è®¸ç‚¹å‡»ç©¿é€ */
  }

  /* è§†é¢‘æ’­æ”¾æ—¶çš„çŠ¶æ€ */
  :global(.direct-video-container.playing .dynamic-video-badge) {
    opacity: 0;
    transform: scale(0.8) translateY(-8px);
    pointer-events: none;
  }

  /* è§†é¢‘æš‚åœæ—¶æ¢å¤æ˜¾ç¤º */
  :global(.direct-video-container.paused .dynamic-video-badge),
  :global(.direct-video-container:not(.playing) .dynamic-video-badge) {
    opacity: 1;
    transform: scale(1) translateY(0);
    pointer-events: none;
  }

  /* æ‚¬åœæ—¶ç¨å¾®æ·¡åŒ–ä½†ä¿æŒå¯è§ */
  :global(.direct-video-container:hover .dynamic-video-badge) {
    opacity: 0.8;
  }

  /* ğŸ¯ æ‰‹æœºç‰ˆä¸“ç”¨ - ç²¾è‡´å°å°ºå¯¸VIDEOå›¾æ ‡ */
  @media (max-width: 768px) {
    :global(#categoryArticlesList .video-type-badge) {
      padding: 4px 8px !important;
      font-size: 0.65rem !important;
      gap: 4px !important;
      top: 8px !important;
      left: 8px !important;
      border-radius: 6px !important;
    }
    
    :global(#categoryArticlesList .video-type-badge.enhanced) {
      padding: 4px 8px !important;
      font-size: 0.65rem !important;
      top: 8px !important;
      left: 8px !important;
    }
    
    :global(#categoryArticlesList .video-type-badge svg) {
      width: 12px !important;
      height: 12px !important;
    }
    
    :global(.dynamic-video-badge) {
      top: 8px !important;
      bottom: auto;
      right: auto;
      left: 8px !important;
      font-size: 0.65rem !important;
      padding: 4px 8px !important;
      gap: 4px !important;
    }
    
    :global(.dynamic-video-badge svg) {
      width: 12px !important;
      height: 12px !important;
    }
  }

  }
</style>

<script>
  // Smart client-side update: only update if localStorage has more articles than SSR
  document.addEventListener('DOMContentLoaded', async function() {
    const categoryArticlesList = document.getElementById('categoryArticlesList');
    if (!categoryArticlesList) return;

    // Get current category from URL
    const pathParts = window.location.pathname.split('/');
    const currentCategory = pathParts[pathParts.length - 1];
    
    // Count current articles on page
    const currentArticleCount = categoryArticlesList.querySelectorAll('.large-article-card').length;
    
    // ğŸ¬ ä¸ºåˆå§‹æ¸²æŸ“çš„ç›´æ¥è§†é¢‘æ–‡ä»¶ç”Ÿæˆç¼©ç•¥å›¾
    generateInitialVideoThumbnails();
    
    // ğŸ¬ åˆå§‹åŒ–è§†é¢‘æ’­æ”¾çŠ¶æ€ç®¡ç†
    initializeVideoPlayerStates();
    
    // Smart caching: Check cache first, then API for latest articles
    try {
      // Cache configuration
      const cacheKey = 'category_articles_cache';
      const cacheTimeKey = 'category_articles_cache_time';
      const CACHE_DURATION = 30000; // 30 seconds cache
      
      const cachedData = localStorage.getItem(cacheKey);
      const cacheTime = localStorage.getItem(cacheTimeKey);
      const now = Date.now();
      
      let allArticles = null;
      
      // Check if we have valid cached data
      if (cachedData && cacheTime && (now - parseInt(cacheTime)) < CACHE_DURATION) {
        // console.log('ğŸš€ Using cached articles data - instant load!');
        allArticles = JSON.parse(cachedData);
      } else {
        // console.log('ğŸ“¡ Fetching fresh articles data from API...');
        
        // Create abort controller for request timeout
        const controller = new AbortController();
        const timeoutId = setTimeout(() => {
          controller.abort();
          console.warn('â° API request timed out after 8 seconds');
        }, 8000); // 8 second timeout
        
        try {
          const response = await fetch('/api/articles', {
            signal: controller.signal
          });
          clearTimeout(timeoutId);
          
          if (response.ok) {
            const data = await response.json();
            // ğŸš€ å¤„ç†æ–°çš„APIå“åº”æ ¼å¼
            allArticles = data.articles || (Array.isArray(data) ? data : []);
            // Cache the fresh data
            localStorage.setItem(cacheKey, JSON.stringify(allArticles));
            localStorage.setItem(cacheTimeKey, now.toString());
            // console.log('âœ… Fresh data fetched and cached');
          } else {
            throw new Error(`API responded with status: ${response.status}`);
          }
        } catch (fetchError) {
          clearTimeout(timeoutId);
          throw fetchError;
        }
      }
      
      if (allArticles && Array.isArray(allArticles)) {
        const categoryArticles = allArticles
          .filter((article: any) => article.category === currentCategory)
          .sort((a: any, b: any) => new Date(b.publishDate).getTime() - new Date(a.publishDate).getTime());
        
        // Only update if we have more articles than what's currently displayed
        if (categoryArticles.length > currentArticleCount) {
          console.log(`ğŸ“° Found ${categoryArticles.length - currentArticleCount} new articles, updating page...`);
          updateCategoryArticles(categoryArticles);
        } else {
          console.log(`âœ“ Articles count (${categoryArticles.length}) matches current display (${currentArticleCount})`);
        }
      }
    } catch (error) {
      console.error('âŒ Error fetching articles from API:', error);
      // Enhanced fallback strategy
      try {
        // Try legacy localStorage first
        const storedArticles = localStorage.getItem('imacx_articles');
        if (storedArticles) {
          // console.log('ğŸ”„ Using fallback: legacy localStorage data');
          const parsedArticles = JSON.parse(storedArticles);
          // ğŸš€ ç¡®ä¿æ•°æ®æ˜¯æ•°ç»„æ ¼å¼
          const articlesArray = Array.isArray(parsedArticles) ? parsedArticles : (parsedArticles.articles || []);
          const categoryArticles = articlesArray
            .filter((article: any) => article.category === currentCategory)
            .sort((a: any, b: any) => new Date(b.publishDate).getTime() - new Date(a.publishDate).getTime());
          
          if (categoryArticles.length > currentArticleCount) {
            console.log(`ğŸ“‹ Fallback: Found ${categoryArticles.length - currentArticleCount} new articles from localStorage`);
            updateCategoryArticles(categoryArticles);
          }
        } else {
          console.warn('âš ï¸ No fallback data available, keeping current content');
        }
      } catch (fallbackError) {
        console.error('ğŸ’¥ All fallback strategies failed:', fallbackError);
      }
    }
  });

  // ğŸ¬ å®¢æˆ·ç«¯YouTube URLæ£€æµ‹å’Œè½¬æ¢å‡½æ•°
  function isEmbeddableVideoClient(url: string): boolean {
    if (!url) return false;
    try {
      const hostname = new URL(url.includes('http') ? url : 'https://' + url).hostname.toLowerCase();
      return hostname.includes('youtube.com') || hostname.includes('youtu.be') || hostname.includes('vimeo.com');
    } catch {
      return false;
    }
  }

  function convertToEmbedUrlClient(url: string): string {
    try {
      let videoUrl = url.trim();
      if (!videoUrl.match(/^https?:\/\//)) {
        videoUrl = 'https://' + videoUrl;
      }
      
      const parsedUrl = new URL(videoUrl);
      const hostname = parsedUrl.hostname.toLowerCase();
      
      // YouTube URLs
      if (hostname.includes('youtube.com') || hostname.includes('youtu.be')) {
        let videoId;
        
        if (hostname.includes('youtu.be')) {
          videoId = parsedUrl.pathname.slice(1);
        } else if (parsedUrl.searchParams.has('v')) {
          videoId = parsedUrl.searchParams.get('v');
        } else {
          const match = parsedUrl.pathname.match(/\/embed\/([^/?]+)/);
          if (match) videoId = match[1];
        }
        
        if (videoId) {
          return `https://www.youtube.com/embed/${videoId}`;
        }
      }
      
      // Vimeo URLs
      if (hostname.includes('vimeo.com')) {
        const match = parsedUrl.pathname.match(/\/(\d+)/);
        if (match) {
          return `https://player.vimeo.com/video/${match[1]}`;
        }
      }
      
      return url; // Return original if conversion fails
    } catch (error) {
      console.warn('Failed to convert video URL:', error);
      return url;
    }
  }

  function formatDurationClient(seconds: number): string {
    if (!seconds || seconds <= 0) return '0:00';
    const minutes = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return `${minutes}:${secs.toString().padStart(2, '0')}`;
  }

  // ğŸ¬ å®¢æˆ·ç«¯YouTubeè§†é¢‘IDæå–å‡½æ•°
  function getYouTubeVideoIdClient(url: string): string | null {
    try {
      let videoUrl = url.trim();
      if (!videoUrl.match(/^https?:\/\//)) {
        videoUrl = 'https://' + videoUrl;
      }
      
      const parsedUrl = new URL(videoUrl);
      const hostname = parsedUrl.hostname.toLowerCase();
      
      if (hostname.includes('youtube.com') || hostname.includes('youtu.be')) {
        let videoId;
        
        if (hostname.includes('youtu.be')) {
          videoId = parsedUrl.pathname.slice(1);
        } else if (parsedUrl.searchParams.has('v')) {
          videoId = parsedUrl.searchParams.get('v');
        } else {
          const match = parsedUrl.pathname.match(/\/embed\/([^/?]+)/);
          if (match) videoId = match[1];
        }
        
        return videoId;
      }
      
      return null;
    } catch (error) {
      console.warn('Failed to extract YouTube video ID:', error);
      return null;
    }
  }

  // ğŸ¬ å®¢æˆ·ç«¯YouTubeç¼©ç•¥å›¾è·å–å‡½æ•°
  function getYouTubeThumbnailClient(url: string, quality: string = 'maxresdefault'): string | null {
    const videoId = getYouTubeVideoIdClient(url);
    if (!videoId) return null;
    
    return `https://img.youtube.com/vi/${videoId}/${quality}.jpg`;
  }

  // ğŸ¬ å®¢æˆ·ç«¯è§†é¢‘ç¼©ç•¥å›¾ç”Ÿæˆå‡½æ•°
  async function generateVideoThumbnailClient(videoUrl: string, width: number = 320, height: number = 180): Promise<string | null> {
    return new Promise((resolve) => {
      try {
        window.debugLog && window.debugLog(`ğŸ¬ Starting thumbnail generation for: ${videoUrl}`);
        
        // Create video element
        const video = document.createElement('video');
        video.crossOrigin = 'anonymous';
        video.preload = 'metadata';
        video.muted = true;
        video.playsInline = true;
        video.style.display = 'none';
        
        // Add to DOM temporarily (some browsers require this)
        document.body.appendChild(video);
        
        let isResolved = false;
        
        const cleanup = () => {
          if (video.parentNode) {
            video.parentNode.removeChild(video);
          }
        };
        
        const resolveOnce = (result: string | null) => {
          if (!isResolved) {
            isResolved = true;
            cleanup();
            resolve(result);
          }
        };
        
        video.onloadedmetadata = () => {
          console.log(`ğŸ¬ Video metadata loaded, duration: ${video.duration}s`);
          // Try multiple time points to avoid black frames
          const timePoints = [1, 0.5, 2, 0.1];
          let currentAttempt = 0;
          
          const tryNextTimePoint = () => {
            if (currentAttempt < timePoints.length) {
              const timePoint = Math.min(timePoints[currentAttempt], video.duration - 0.1);
              window.debugLog && window.debugLog(`ğŸ¬ Attempting thumbnail at ${timePoint}s`);
              video.currentTime = timePoint;
              currentAttempt++;
            } else {
              console.warn('âŒ All time points failed');
              resolveOnce(null);
            }
          };
          
          tryNextTimePoint();
        };
        
        video.onseeked = () => {
          try {
            window.debugLog && window.debugLog(`ğŸ¬ Video seeked to ${video.currentTime}s, generating thumbnail...`);
            
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            if (!ctx) {
              console.warn('âŒ Cannot get canvas context');
              resolveOnce(null);
              return;
            }
            
            canvas.width = width;
            canvas.height = height;
            
            // Draw video frame to canvas
            ctx.drawImage(video, 0, 0, width, height);
            
            // Check if the frame is not completely black
            const imageData = ctx.getImageData(0, 0, width, height);
            const pixels = imageData.data;
            let totalBrightness = 0;
            
            for (let i = 0; i < pixels.length; i += 4) {
              totalBrightness += (pixels[i] + pixels[i + 1] + pixels[i + 2]) / 3;
            }
            
            const averageBrightness = totalBrightness / (pixels.length / 4);
            console.log(`ğŸ¬ Frame brightness: ${averageBrightness}`);
            
            if (averageBrightness < 10) {
              // Frame is too dark, try next time point
              console.warn('âš ï¸ Frame too dark, trying next time point');
              const timePoints = [1, 0.5, 2, 0.1];
              if (video.currentTime < timePoints[timePoints.length - 1] + 0.1) {
                video.currentTime = Math.min(video.currentTime + 1, video.duration - 0.1);
                return;
              }
            }
            
            // Convert to data URL
            const thumbnailUrl = canvas.toDataURL('image/jpeg', 0.8);
            window.debugLog && window.debugLog(`âœ… Thumbnail generated successfully (${thumbnailUrl.length} bytes)`);
            resolveOnce(thumbnailUrl);
            
          } catch (error) {
            console.warn('âŒ Failed to generate video thumbnail:', error);
            resolveOnce(null);
          }
        };
        
        video.onerror = (e) => {
          console.warn('âŒ Video loading error:', e);
          resolveOnce(null);
        };
        
        video.onabort = () => {
          console.warn('âŒ Video loading aborted');
          resolveOnce(null);
        };
        
        // Set video source and load
        video.src = videoUrl;
        video.load();
        
        // Timeout fallback
        setTimeout(() => {
          console.warn('â° Thumbnail generation timeout');
          resolveOnce(null);
        }, 10000); // 10 second timeout
        
      } catch (error) {
        console.warn('âŒ Video thumbnail generation error:', error);
        resolve(null);
      }
    });
  }

  // ğŸ¬ ç®€åŒ–çš„è§†é¢‘ç¼©ç•¥å›¾ç”Ÿæˆæ–¹æ³•ï¼ˆæ— è·¨åŸŸé™åˆ¶ï¼‰
  async function generateSimpleVideoThumbnailClient(videoUrl: string): Promise<string | null> {
    return new Promise((resolve) => {
      try {
        console.log(`ğŸ¬ Trying simple method for: ${videoUrl}`);
        
        const video = document.createElement('video');
        video.muted = true;
        video.playsInline = true;
        video.style.display = 'none';
        // ä¸è®¾ç½®crossOriginï¼Œé¿å…è·¨åŸŸé—®é¢˜
        
        let isResolved = false;
        const resolveOnce = (result: string | null) => {
          if (!isResolved) {
            isResolved = true;
            resolve(result);
          }
        };
        
        video.oncanplay = () => {
          try {
            console.log(`ğŸ¬ Simple method: video can play, attempting capture`);
            video.currentTime = 1; // è·³è½¬åˆ°1ç§’ä½ç½®
          } catch (error) {
            console.warn('ğŸ¬ Simple method seek failed:', error);
            resolveOnce(null);
          }
        };
        
        video.onseeked = () => {
          try {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            if (!ctx) {
              resolveOnce(null);
              return;
            }
            
            canvas.width = 320;
            canvas.height = 180;
            ctx.drawImage(video, 0, 0, 320, 180);
            
            const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
            console.log(`âœ… Simple method succeeded`);
            resolveOnce(dataUrl);
          } catch (error) {
            console.warn('ğŸ¬ Simple method canvas failed:', error);
            resolveOnce(null);
          }
        };
        
        video.onerror = () => {
          console.warn('ğŸ¬ Simple method: video error');
          resolveOnce(null);
        };
        
        video.src = videoUrl;
        video.load();
        
        setTimeout(() => resolveOnce(null), 5000);
        
      } catch (error) {
        console.warn('ğŸ¬ Simple method exception:', error);
        resolve(null);
      }
    });
  }

  // ğŸ¬ ä½¿ç”¨videoå…ƒç´ çš„posterå±æ€§ä½œä¸ºç¼©ç•¥å›¾
  function useVideoPosterAsThumbClient(videoUrl: string, imgElement: HTMLElement) {
    try {
      console.log(`ğŸ¬ Using video poster method for: ${videoUrl}`);
      
      // åˆ›å»ºä¸€ä¸ªéšè—çš„videoå…ƒç´ æ¥è·å–poster
      const video = document.createElement('video');
      video.style.display = 'none';
      video.style.position = 'absolute';
      video.style.top = '-9999px';
      video.width = 320;
      video.height = 180;
      video.muted = true;
      video.preload = 'metadata';
      
      document.body.appendChild(video);
      
      video.onloadedmetadata = () => {
        try {
          // å°è¯•ç”Ÿæˆposter
          video.currentTime = 1;
          
          setTimeout(() => {
            try {
              const canvas = document.createElement('canvas');
              const ctx = canvas.getContext('2d');
              if (ctx) {
                canvas.width = 320;
                canvas.height = 180;
                ctx.fillStyle = '#6366f1'; // ä½¿ç”¨å“ç‰Œè‰²ä½œä¸ºèƒŒæ™¯
                ctx.fillRect(0, 0, 320, 180);
                
                // æ·»åŠ è§†é¢‘å›¾æ ‡
                ctx.fillStyle = 'white';
                ctx.font = '48px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('â–¶', 160, 110);
                
                const posterUrl = canvas.toDataURL('image/jpeg', 0.8);
                imgElement.src = posterUrl;
                // console.log(`âœ… Generated fallback poster for: ${videoUrl}`);
              }
            } catch (error) {
              console.warn('ğŸ¬ Fallback poster generation failed:', error);
            } finally {
              if (video.parentNode) {
                video.parentNode.removeChild(video);
              }
            }
          }, 1000);
          
        } catch (error) {
          console.warn('ğŸ¬ Video poster metadata error:', error);
          if (video.parentNode) {
            video.parentNode.removeChild(video);
          }
        }
      };
      
      video.onerror = () => {
        console.warn('ğŸ¬ Video poster loading failed');
        if (video.parentNode) {
          video.parentNode.removeChild(video);
        }
      };
      
      video.src = videoUrl;
      video.load();
      
    } catch (error) {
      console.warn('ğŸ¬ Video poster method failed:', error);
    }
  }

  // ğŸ¬ ç«‹å³ç”Ÿæˆè§†é¢‘å›¾æ ‡ç¼©ç•¥å›¾ï¼ˆæ— å»¶è¿Ÿï¼‰
  function generateInstantVideoIconClient(imgElement: HTMLElement) {
    try {
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      if (!ctx) return;
      
      canvas.width = 320;
      canvas.height = 180;
      
      // åˆ›å»ºæ¸å˜èƒŒæ™¯
      const gradient = ctx.createLinearGradient(0, 0, 320, 180);
      gradient.addColorStop(0, '#8b5cf6'); // ç´«è‰²
      gradient.addColorStop(1, '#3b82f6'); // è“è‰²
      
      ctx.fillStyle = gradient;
      ctx.fillRect(0, 0, 320, 180);
      
      // æ·»åŠ è§†é¢‘æ’­æ”¾å›¾æ ‡
      ctx.fillStyle = 'white';
      ctx.beginPath();
      // ç»˜åˆ¶ä¸‰è§’å½¢æ’­æ”¾æŒ‰é’®
      ctx.moveTo(120, 60);
      ctx.lineTo(120, 120);
      ctx.lineTo(180, 90);
      ctx.closePath();
      ctx.fill();
      
      // æ·»åŠ æ–‡å­— - æ”¹ä¸ºå·¦ä¸Šè§’å°å°ºå¯¸ï¼Œå‚è€ƒYouTubeé£æ ¼
      ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
      ctx.font = 'bold 10px Arial';
      ctx.textAlign = 'left';
      ctx.fillText('VIDEO', 1, 25);
      
      const thumbnailUrl = canvas.toDataURL('image/jpeg', 0.8);
      imgElement.src = thumbnailUrl;
      
      window.debugLog && window.debugLog(`âœ… Generated instant video icon thumbnail`);
    } catch (error) {
      console.warn('Failed to generate instant video icon:', error);
    }
  }

  function updateCategoryArticles(articles: any[]) {
    const categoryArticlesList = document.getElementById('categoryArticlesList');
    if (!categoryArticlesList) return;

    // Generate new HTML for all articles with YouTube support
    const articlesHTML = articles.map((article: any, index: number) => {
      const isVideo = article.mediaType === 'VIDEO' && article.videoUrl;
      const isYoutube = isVideo && isEmbeddableVideoClient(article.videoUrl);
      const needsVideoThumbnail = isVideo && !isYoutube && !article.videoPoster && !article.image;
      
      // ğŸ¬ ç”Ÿæˆåª’ä½“å†…å®¹HTML
      let mediaHTML;
      if (isVideo) {
        if (isYoutube) {
          // YouTube/Vimeo iframe
          mediaHTML = `
            <div class="article-video-wrapper">
              <div class="video-iframe-container">
                <iframe 
                  src="${convertToEmbedUrlClient(article.videoUrl)}"
                  class="article-video-iframe"
                  width="800"
                  height="450"
                  frameborder="0"
                  allowfullscreen
                  allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                  title="${article.title}"
                ></iframe>
                <div class="video-type-badge enhanced">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="white" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M23 7l-7 5 7 5z"/>
                    <rect x="1" y="5" width="15" height="14" rx="2" ry="2"/>
                  </svg>
                  <span>YOUTUBE</span>
                </div>
                ${article.videoDuration ? `<div class="video-duration-badge-top-right">${formatDurationClient(article.videoDuration)}</div>` : ''}
              </div>
            </div>
          `;
        } else {
          // ç›´æ¥è§†é¢‘æ–‡ä»¶
          mediaHTML = `
            <div class="article-video-wrapper">
              <div class="direct-video-container">
                <video 
                  controls 
                  poster="${article.videoPoster || article.image || '/images/placeholder.svg'}"
                  preload="metadata"
                  playsinline
                  class="article-video"
                  width="800"
                  height="450"
                >
                  <source src="${article.videoUrl}" type="video/mp4">
                  <source src="${article.videoUrl}" type="video/webm">
                  <source src="${article.videoUrl}" type="video/ogg">
                  Your browser does not support the video tag.
                </video>
                <div class="video-type-badge">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M23 7l-7 5 7 5z"/>
                    <rect x="1" y="5" width="15" height="14" rx="2" ry="2"/>
                  </svg>
                  VIDEO
                </div>
                ${article.videoDuration ? `<div class="video-duration-badge">${formatDurationClient(article.videoDuration)}</div>` : ''}
              </div>
            </div>
          `;
        }
      } else {
        // å›¾ç‰‡ - å¦‚æœæ˜¯è§†é¢‘ä½†ä¸æ˜¯YouTubeï¼Œä¹Ÿè¦å°è¯•è·å–YouTubeç¼©ç•¥å›¾
        let imageSrc = article.image;
        if (article.mediaType === 'VIDEO' && isEmbeddableVideoClient(article.videoUrl)) {
          const youtubeThumbnail = getYouTubeThumbnailClient(article.videoUrl);
          imageSrc = youtubeThumbnail || article.image || '/images/placeholder.svg';
        }
        
        mediaHTML = `
            <img 
              src="${imageSrc}" 
              alt="${article.title}"
              class="article-image"
              data-article-id="${article.id}"
              data-video-url="${isVideo ? article.videoUrl || '' : ''}"
              data-needs-thumbnail="${needsVideoThumbnail ? 'true' : 'false'}"
              loading="lazy"
              width="800"
              height="450"
            />
        `;
      }

      return `
        <div class="large-article-card">
          <div class="article-media-container">
            ${mediaHTML}
          </div>
          
          <div class="article-content">
            <div class="article-meta">
              <a href="/category/${article.category}" class="category-tag ${article.category}">
                ${article.category === 'TodayNews' ? 'Today News' : 'Past News'}
              </a>
              <span class="publish-date">${formatDate(article.publishDate)}</span>
            </div>
            
            <h2 class="article-title">
              <a href="/article/${article.slug}">${article.title}</a>
            </h2>
            
            <p class="article-excerpt">${article.excerpt}</p>
            
            <div class="article-footer">
              <span class="author">By ${article.author}</span>
              <a href="/article/${article.slug}" class="read-more-btn">
                ${isVideo ? 'Watch Video' : 'Read more'}
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <line x1="5" y1="12" x2="19" y2="12"></line>
                  <path d="M12 5l7 7-7 7"></path>
                </svg>
              </a>
            </div>
          </div>
        </div>
      `;
    }).join('');

    // Update content smoothly
    categoryArticlesList.innerHTML = articlesHTML;
    
    // ğŸ¬ å¼‚æ­¥ç”Ÿæˆç›´æ¥è§†é¢‘æ–‡ä»¶çš„ç¼©ç•¥å›¾
    articles.forEach((article: any, index: number) => {
      const isVideo = article.mediaType === 'VIDEO' && article.videoUrl;
      const isYoutube = isVideo && isEmbeddableVideoClient(article.videoUrl);
      const needsVideoThumbnail = isVideo && !isYoutube && !article.videoPoster && !article.image;
      
      if (needsVideoThumbnail) {
        setTimeout(async () => {
          try {
            window.debugLog && window.debugLog(`ğŸ¬ Generating thumbnail for category video: ${article.title}`);
            const generatedThumbnail = await generateVideoThumbnailClient(article.videoUrl);
            if (generatedThumbnail) {
              const imgElement = categoryArticlesList.querySelector(`img[data-article-id="${article.id}"]`);
              if (imgElement) {
                imgElement.src = generatedThumbnail;
                window.debugLog && window.debugLog(`âœ… Updated category thumbnail for: ${article.title}`);
              }
            }
          } catch (error) {
            console.warn(`Failed to generate category thumbnail for ${article.title}:`, error);
          }
        }, index * 300); // å»¶è¿Ÿç”Ÿæˆï¼Œé¿å…åŒæ—¶å¤„ç†å¤ªå¤šè§†é¢‘
      }
    });
  }

  // ğŸ¬ åˆå§‹åŒ–è§†é¢‘æ’­æ”¾çŠ¶æ€ç®¡ç†
  function initializeVideoPlayerStates() {
    const videoElements = document.querySelectorAll('.direct-video-container video');
    console.log(`ğŸ¬ Found ${videoElements.length} direct video elements to initialize`);
    
    videoElements.forEach((video) => {
      const videoEl = video as HTMLVideoElement;
      const container = videoEl.closest('.direct-video-container') as HTMLElement;
      if (!container) return;
      
      // æ·»åŠ æ’­æ”¾äº‹ä»¶ç›‘å¬å™¨
      videoEl.addEventListener('play', () => {
        console.log('ğŸ¬ Video started playing, hiding VIDEO badge');
        container.classList.add('playing');
        container.classList.remove('paused');
      });
      
      // æ·»åŠ æš‚åœäº‹ä»¶ç›‘å¬å™¨
      videoEl.addEventListener('pause', () => {
        console.log('ğŸ¬ Video paused, showing VIDEO badge');
        container.classList.remove('playing');
        container.classList.add('paused');
      });
      
      // æ·»åŠ ç»“æŸäº‹ä»¶ç›‘å¬å™¨
      videoEl.addEventListener('ended', () => {
        console.log('ğŸ¬ Video ended, resetting VIDEO badge');
        container.classList.remove('playing');
        container.classList.remove('paused');
      });
      
      // æ·»åŠ åŠ è½½å®Œæˆäº‹ä»¶ç›‘å¬å™¨
      videoEl.addEventListener('loadeddata', () => {
        // console.log('ğŸ¬ Video loaded, ensuring VIDEO badge is visible');
        container.classList.remove('playing');
        container.classList.remove('paused');
      });
    });
  }

  // ğŸ¬ ç”Ÿæˆåˆå§‹é¡µé¢åŠ è½½æ—¶çš„è§†é¢‘ç¼©ç•¥å›¾
  function generateInitialVideoThumbnails() {
    const articleImages = document.querySelectorAll('#categoryArticlesList img[data-article-id]');
    window.debugLog && window.debugLog(`ğŸ¬ Found ${articleImages.length} article images for thumbnail generation`);
    
    articleImages.forEach((imgElement, index) => {
      const needsThumbnail = imgElement.getAttribute('data-needs-thumbnail') === 'true';
      const videoUrl = imgElement.getAttribute('data-video-url');
      const imgSrc = imgElement.src;
      
      console.log(`ğŸ¬ Article ${index}: needsThumbnail=${needsThumbnail}, videoUrl=${videoUrl}, imgSrc contains placeholder=${imgSrc.includes('placeholder')}`);
      
      // Also try to generate thumbnails for images showing placeholder, even if not marked
      const shouldTryGenerate = needsThumbnail || (videoUrl && imgSrc.includes('placeholder.svg'));
      
      if (shouldTryGenerate && videoUrl && !isEmbeddableVideoClient(videoUrl)) {
        window.debugLog && window.debugLog(`ğŸ¬ Will attempt thumbnail generation for: ${videoUrl}`);
        
        // ç«‹å³ç”Ÿæˆä¸€ä¸ªä¸´æ—¶çš„è§†é¢‘å›¾æ ‡ç¼©ç•¥å›¾
        generateInstantVideoIconClient(imgElement);
        
        setTimeout(async () => {
          try {
            window.debugLog && window.debugLog(`ğŸ¬ Starting thumbnail generation for direct video: ${videoUrl}`);
            
            // Try a simpler approach first - use video poster frame
            const simpleThumb = await generateSimpleVideoThumbnailClient(videoUrl);
            if (simpleThumb) {
              imgElement.src = simpleThumb;
              window.debugLog && window.debugLog(`âœ… Updated thumbnail using simple method: ${videoUrl}`);
              return;
            }
            
            // Fallback to complex method
            const generatedThumbnail = await generateVideoThumbnailClient(videoUrl);
            if (generatedThumbnail) {
              imgElement.src = generatedThumbnail;
              window.debugLog && window.debugLog(`âœ… Updated thumbnail using complex method: ${videoUrl}`);
            } else {
              console.warn(`âŒ Both methods failed for video: ${videoUrl}`);
              // Use a video poster as fallback
              useVideoPosterAsThumbClient(videoUrl, imgElement);
            }
          } catch (error) {
            console.warn(`Failed to generate thumbnail for video ${videoUrl}:`, error);
            useVideoPosterAsThumbClient(videoUrl, imgElement);
          }
        }, index * 200 + 500); // ç¼©çŸ­å»¶è¿Ÿï¼Œå¿«é€Ÿç”Ÿæˆ
      }
    });
  }

  function formatDate(dateString: string) {
    const date = new Date(dateString);
    return date.toLocaleDateString('en-US', { 
      year: 'numeric', 
      month: 'short', 
      day: 'numeric' 
    });
  }

  // ğŸš€ ENHANCED real-time update mechanism with Cache Sync Manager
  let updateTimeout: NodeJS.Timeout;
  function debouncedUpdate() {
    clearTimeout(updateTimeout);
    updateTimeout = setTimeout(async () => {
      console.log('ğŸ”„ CategoryLayout: Processing real-time update...');
      
      // ğŸ§¹ Use Cache Sync Manager for comprehensive cache management
      if ((window as any).cacheSyncManager) {
        window.debugLog && window.debugLog('âœ… Using Cache Sync Manager for cache clearing...');
        (window as any).cacheSyncManager.clearAllCaches();
        
        // Check cache consistency and trigger database sync if needed
        try {
          const isConsistent = await (window as any).cacheSyncManager.checkCacheConsistency();
          if (!isConsistent) {
            window.debugLog && window.debugLog('âš ï¸ Cache inconsistency detected, triggering database sync...');
            await (window as any).cacheSyncManager.triggerDatabaseSync();
          }
        } catch (e) {
          console.warn('âš ï¸ Cache consistency check failed:', e);
        }
      } else {
        // Fallback cache clearing if Cache Sync Manager is not loaded yet
        window.debugLog && window.debugLog('âš ï¸ Cache Sync Manager not available, using fallback...');
        if ((window as any).clearAllArticleCaches) {
          (window as any).clearAllArticleCaches();
        } else {
          localStorage.removeItem('category_articles_cache');
          localStorage.removeItem('category_articles_cache_time');
          localStorage.removeItem('imacx_articles');
          localStorage.removeItem('imacx_articles_cache');
          if ('caches' in window) {
            caches.delete('api-cache').catch(() => {});
          }
        }
      }
      
      window.debugLog && window.debugLog('ğŸ”„ Cache clearing completed, reloading page for real-time update...');
      location.reload();
    }, 200); // âš¡ Further reduced debounce to 200ms for faster response with Cache Sync Manager
  }

  // Page visibility API - only update when page is visible
  document.addEventListener('visibilitychange', function() {
    if (document.visibilityState === 'visible') {
      console.log('ğŸ‘ï¸ Page became visible, checking for updates...');
      debouncedUpdate();
    }
  });

  // ğŸ“¡ Listen for ALL article events from Admin Manager for real-time sync
  window.addEventListener('articlePublished', () => {
    console.log('ğŸ“¢ Article published event received - triggering real-time update');
    debouncedUpdate();
  });

  window.addEventListener('articleUpdated', () => {
    console.log('ğŸ“¢ Article updated event received - triggering real-time update');
    debouncedUpdate();
  });

  // ğŸ—‘ï¸ NEW: Listen for article deletion events  
  window.addEventListener('articleDeleted', (event: any) => {
    console.log('ğŸ“¢ Article deleted event received - triggering real-time update');
    console.log('ğŸ—‘ï¸ Deleted article ID:', event.detail?.articleId);
    debouncedUpdate();
  });

  // Listen for logout events to clear cache
  window.addEventListener('userLoggedOut', () => {
    console.log('ğŸšª User logged out, clearing cache...');
    localStorage.removeItem('category_articles_cache');
    localStorage.removeItem('category_articles_cache_time');
  });
</script>

<!-- æ™ºèƒ½è‡ªåŠ¨Footerä½ç½®è°ƒèŠ‚ -->
<script is:inline>
document.addEventListener('DOMContentLoaded', function() {
  // console.log('ğŸš€ å¯åŠ¨æ™ºèƒ½Footerè‡ªåŠ¨å®šä½ç³»ç»Ÿ...');
  
  // æ·»åŠ å…¨å±€é˜²æŠ–æœºåˆ¶ï¼Œé¿å…å‡½æ•°è¢«é¢‘ç¹è°ƒç”¨
  let footerPositionTimeout;
  function autoPositionFooter() {
    clearTimeout(footerPositionTimeout);
    footerPositionTimeout = setTimeout(function() {
      // è·å–å…³é”®å…ƒç´ 
      const footer = document.querySelector('.site-footer');
      const articlesList = document.querySelector('.articles-list');
      const articles = document.querySelectorAll('.articles-list .large-article-card');
      
      if (!footer || !articlesList || articles.length === 0) {
        console.warn('âŒ æ‰¾ä¸åˆ°å¿…è¦å…ƒç´ :', { footer: !!footer, articlesList: !!articlesList, articles: articles.length });
        return;
      }
      
      // console.log('ğŸ“Š æ‰¾åˆ°', articles.length, 'ç¯‡æ–‡ç« ');
      
      // æ·»åŠ è¿è¡Œæ ‡è®°ï¼Œé˜²æ­¢é‡å¤æ‰§è¡Œ
      if (footer.dataset.positioning === 'true') {
        // console.log('ğŸ”„ Footeræ­£åœ¨å®šä½ä¸­ï¼Œè·³è¿‡æœ¬æ¬¡æ‰§è¡Œ');
        return;
      }
      footer.dataset.positioning = 'true';
    
    // ğŸ¯ åŠ¨æ€è®¡ç®—ç§»åŠ¨ç«¯articles-listæœ€å°é«˜åº¦
    if (window.innerWidth <= 768) {
      // è®¡ç®—æ‰€æœ‰æ–‡ç« çš„æ€»é«˜åº¦
      let totalArticlesHeight = 0;
      articles.forEach(article => {
        totalArticlesHeight += article.offsetHeight;
      });
      
      // åŠ ä¸Šæ–‡ç« é—´çš„é—´è· (articles.length - 1) * gap
      const articleGap = 32; // var(--space-8) â‰ˆ 32px
      const totalGapHeight = (articles.length - 1) * articleGap;
      
      // è®¡ç®—åŠ¨æ€æœ€å°é«˜åº¦ï¼šæ–‡ç« æ€»é«˜åº¦ + é—´è· + é¢å¤–ç¼“å†²
      const dynamicMinHeight = totalArticlesHeight + totalGapHeight + 120; // ç§»åŠ¨ç«¯æ¢å¤ç¼“å†²åˆ°80px
      
      // è®¾ç½®åŠ¨æ€æœ€å°é«˜åº¦
      articlesList.style.minHeight = dynamicMinHeight + 'px';
      
      // console.log('ğŸ“± ç§»åŠ¨ç«¯åŠ¨æ€è®¾ç½®:');
      // console.log('  æ–‡ç« æ€»é«˜åº¦:', totalArticlesHeight, 'px');
      // console.log('  é—´è·æ€»é«˜åº¦:', totalGapHeight, 'px');
      // console.log('  åŠ¨æ€æœ€å°é«˜åº¦:', dynamicMinHeight, 'px');
    } else {
      // æ¡Œé¢ç«¯æ¸…é™¤æœ€å°é«˜åº¦é™åˆ¶
      articlesList.style.minHeight = '';
    }
    
    // é‡ç½®Footerçš„margin-topï¼Œè®©æˆ‘ä»¬é‡æ–°è®¡ç®—
    footer.style.marginTop = '0px';
    footer.style.position = 'relative';
    footer.style.clear = 'both';
    footer.style.display = 'block';
    
    // ç­‰å¾…æ ·å¼é‡ç½®å®Œæˆï¼Œç„¶åè®¡ç®—ä½ç½®
    setTimeout(function() {
      // è·å–æœ€åä¸€ç¯‡æ–‡ç« çš„ä½ç½®
      const lastArticle = articles[articles.length - 1];
      const lastArticleRect = lastArticle.getBoundingClientRect();
      const currentScrollY = window.scrollY;
      
      // è®¡ç®—æœ€åä¸€ç¯‡æ–‡ç« åœ¨æ–‡æ¡£ä¸­çš„ç»å¯¹ä½ç½®
      const lastArticleBottom = lastArticleRect.bottom + currentScrollY;
      
      // è·å–æ–‡ç« åˆ—è¡¨å®¹å™¨çš„åº•éƒ¨ä½ç½®
      const articlesListRect = articlesList.getBoundingClientRect();
      const articlesListBottom = articlesListRect.bottom + currentScrollY;
      
      // è·å–Footerå½“å‰çš„ä½ç½®
      const footerRect = footer.getBoundingClientRect();
      const footerTop = footerRect.top + currentScrollY;
      
      // console.log('ğŸ“ ä½ç½®åˆ†æ:');
      // console.log('  æœ€åæ–‡ç« åº•éƒ¨:', Math.round(lastArticleBottom), 'px');
      // console.log('  æ–‡ç« åˆ—è¡¨åº•éƒ¨:', Math.round(articlesListBottom), 'px');
      // console.log('  Footerå½“å‰é¡¶éƒ¨:', Math.round(footerTop), 'px');
      
      // è®¡ç®—ç†æƒ³çš„Footerä½ç½®ï¼ˆç§»åŠ¨ç«¯å’Œæ¡Œé¢ç«¯ä½¿ç”¨ä¸åŒè·ç¦»ï¼‰
      const isMobile = window.innerWidth <= 768;
      const footerGap = isMobile ? -60 : 60; // ç§»åŠ¨ç«¯10pxï¼Œæ¡Œé¢ç«¯60px
      // console.log(`ğŸ“± è®¾å¤‡æ£€æµ‹: ${isMobile ? 'ç§»åŠ¨ç«¯' : 'æ¡Œé¢ç«¯'} (å®½åº¦: ${window.innerWidth}px, é—´è·: ${footerGap}px)`);
      const idealFooterTop = Math.max(lastArticleBottom, articlesListBottom) + footerGap;
      
      // è®¡ç®—éœ€è¦çš„margin-top
      const requiredMarginTop = Math.max(0, idealFooterTop - footerTop);
      
      // console.log('ğŸ¯ è®¡ç®—ç»“æœ:');
      // console.log('  ç†æƒ³Footerä½ç½®:', Math.round(idealFooterTop), 'px');
      // console.log('  éœ€è¦çš„margin-top:', Math.round(requiredMarginTop), 'px');
      
      // åº”ç”¨è®¡ç®—å‡ºçš„é—´è·
      if (requiredMarginTop > 0) {
        footer.style.marginTop = Math.round(requiredMarginTop) + 'px';
        // console.log(`âœ… Footerå·²è‡ªåŠ¨è°ƒæ•´åˆ°æœ€åæ–‡ç« ä¸‹æ–¹${footerGap}px`);
      } else {
        footer.style.marginTop = footerGap + 'px'; // ä½¿ç”¨ç›¸åº”çš„æœ€å°é—´è·
        console.log(`âœ… Footerä½¿ç”¨æœ€å°é—´è·${footerGap}px`);
      }
      
      // éªŒè¯æœ€ç»ˆä½ç½®
      setTimeout(function() {
        const finalFooterRect = footer.getBoundingClientRect();
        const finalFooterTop = finalFooterRect.top + window.scrollY;
        const finalGap = finalFooterTop - Math.max(lastArticleBottom, articlesListBottom);
        
        // console.log('ğŸ” æœ€ç»ˆéªŒè¯:');
        // console.log('  Footeræœ€ç»ˆä½ç½®:', Math.round(finalFooterTop), 'px');
        // console.log('  ä¸æœ€åæ–‡ç« é—´è·:', Math.round(finalGap), 'px');
        
        // æ ¹æ®ç§»åŠ¨ç«¯/æ¡Œé¢ç«¯è®¾ç½®ä¸åŒçš„éªŒè¯æ ‡å‡†
        const minGap = window.innerWidth <= 768 ? 5 : 40; // ç§»åŠ¨ç«¯æœ€å°5pxï¼Œæ¡Œé¢ç«¯40px
        const maxGap = window.innerWidth <= 768 ? 20 : 100; // ç§»åŠ¨ç«¯æœ€å¤§20pxï¼Œæ¡Œé¢ç«¯100px
        
        if (finalGap >= minGap && finalGap <= maxGap) {
          // console.log('ğŸ‰ å®Œç¾ï¼Footerä½ç½®è‡ªåŠ¨è°ƒæ•´æˆåŠŸ');
        } else if (finalGap >= 0) {
          // console.log('âœ… Footerä½ç½®æ­£å¸¸ï¼Œé—´è·ç¨æœ‰åå·®');
        } else {
          // console.log('âš ï¸ Footerä½ç½®å¯èƒ½æœ‰é‡å ï¼Œéœ€è¦è°ƒæ•´');
        }
        
        // æ¸…é™¤å®šä½æ ‡è®°
        footer.dataset.positioning = 'false';
      }, 100);
      
    }, 100);
    }, 150); // ä¸»é˜²æŠ–å»¶è¿Ÿ150ms
  }
  
  // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
  autoPositionFooter();
  
  // ç›‘å¬çª—å£å¤§å°å˜åŒ–ï¼Œé‡æ–°è°ƒæ•´ï¼ˆä¼˜åŒ–é˜²æŠ–ï¼Œé¿å…ç§»åŠ¨ç«¯æ»šåŠ¨æ—¶çš„é—ªåŠ¨ï¼‰
  let resizeTimeout;
  let lastWindowWidth = window.innerWidth;
  let lastWindowHeight = window.innerHeight;
  
  window.addEventListener('resize', function() {
    clearTimeout(resizeTimeout);
    resizeTimeout = setTimeout(function() {
      const currentWidth = window.innerWidth;
      const currentHeight = window.innerHeight;
      
      // åªæœ‰åœ¨å®½åº¦æˆ–é«˜åº¦æ˜¾è‘—å˜åŒ–æ—¶æ‰é‡æ–°å®šä½ï¼ˆé¿å…ç§»åŠ¨ç«¯æ»šåŠ¨æ—¶åœ°å€æ å¼•èµ·çš„å°å¹…å˜åŒ–ï¼‰
      const widthChange = Math.abs(currentWidth - lastWindowWidth);
      const heightChange = Math.abs(currentHeight - lastWindowHeight);
      
      if (widthChange > 50 || heightChange > 100) {
        // console.log('ğŸ“ çª—å£å¤§å°æ˜¾è‘—æ”¹å˜ï¼Œé‡æ–°è°ƒæ•´Footerä½ç½®...');
        // console.log(`  å®½åº¦å˜åŒ–: ${widthChange}px, é«˜åº¦å˜åŒ–: ${heightChange}px`);
        lastWindowWidth = currentWidth;
        lastWindowHeight = currentHeight;
        autoPositionFooter();
      } else {
        console.log('ğŸ“± å¿½ç•¥å°å¹…resizeï¼ˆå¯èƒ½æ˜¯ç§»åŠ¨ç«¯æ»šåŠ¨å¼•èµ·ï¼‰');
      }
    }, 500); // å¢åŠ é˜²æŠ–æ—¶é—´åˆ°500ms
  });
  
  // ç›‘å¬å›¾ç‰‡åŠ è½½å®Œæˆï¼Œé‡æ–°è°ƒæ•´ï¼ˆå› ä¸ºå›¾ç‰‡åŠ è½½å¯èƒ½æ”¹å˜æ–‡ç« é«˜åº¦ï¼‰
  const images = document.querySelectorAll('.articles-list img');
  let loadedImages = 0;
  const totalImages = images.length;
  
  if (totalImages > 0) {
    images.forEach(function(img) {
      if (img.complete) {
        loadedImages++;
      } else {
        img.addEventListener('load', function() {
          loadedImages++;
          if (loadedImages === totalImages) {
            // console.log('ğŸ–¼ï¸ æ‰€æœ‰å›¾ç‰‡åŠ è½½å®Œæˆï¼Œé‡æ–°è°ƒæ•´Footerä½ç½®...');
            setTimeout(autoPositionFooter, 200);
          }
        });
        
        img.addEventListener('error', function() {
          loadedImages++;
          if (loadedImages === totalImages) {
            // console.log('ğŸ–¼ï¸ å›¾ç‰‡åŠ è½½å®Œæˆï¼ˆå«é”™è¯¯ï¼‰ï¼Œé‡æ–°è°ƒæ•´Footerä½ç½®...');
            setTimeout(autoPositionFooter, 200);
          }
        });
      }
    });
    
    // å¦‚æœæ‰€æœ‰å›¾ç‰‡éƒ½å·²ç»åŠ è½½å®Œæˆ
    if (loadedImages === totalImages) {
      // console.log('ğŸ–¼ï¸ å›¾ç‰‡å·²é¢„åŠ è½½ï¼Œå»¶è¿Ÿè°ƒæ•´Footerä½ç½®...');
      setTimeout(autoPositionFooter, 500);
    }
  }
  
  console.log('ğŸ¯ æ™ºèƒ½Footerå®šä½ç³»ç»Ÿå·²å¯åŠ¨');
});
</script>