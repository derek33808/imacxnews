---
import Layout from './Layout.astro';
import ArticleCard from '../components/ui/ArticleCard.astro';
import { getCategoryById } from '../data/categories';

const { category, articles } = Astro.props;
const categoryInfo = getCategoryById(category) || { id: category, name: String(category || 'News'), description: '' };

const title = `${categoryInfo.name} News | GlobalNews`;
const description = categoryInfo.description;
---

<Layout title={title} description={description}>
  <div class="container">
    <header class="category-header">
      <h1 class="category-title">{categoryInfo.name}</h1>
      <p class="category-description">{categoryInfo.description}</p>
    </header>
    
    <div class="articles-list" id="categoryArticlesList">
      {/** @type {any[]} */ (articles as any[]).map((article: any, index: number) => (
        <div class="large-article-card">
          <div class="article-image-container">
            <img 
              src={article.image} 
              alt={article.title}
              class="article-image"
              loading="lazy"
              width="800"
              height="450"
              onerror="this.onerror=null; this.src='/images/placeholder.svg'"
            />
          </div>
          
          <div class="article-content">
            <div class="article-meta">
              <a href={`/category/${article.category}`} class={`category-tag ${article.category}`}>
                {article.category === 'TodayNews' ? 'Today News' : 'Past News'}
              </a>
              <span class="publish-date">{new Date(article.publishDate).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' })}</span>
            </div>
            
            <h2 class="article-title">
              <a href={`/article/${article.slug}`}>{article.title}</a>
            </h2>
            
            <p class="article-excerpt">{article.excerpt}</p>
            
            <div class="article-footer">
              <span class="author">By {article.author}</span>
              <a href={`/article/${article.slug}`} class="read-more-btn">
                Read more
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg>
              </a>
            </div>
          </div>
        </div>
      ))}
    </div>
  </div>
</Layout>

<!-- Client-side script disabled to prevent content jumping -->
<!-- Script moved to external file if needed in future -->

<style>
  /* 配合 Layout.astro 的 Sticky Footer 布局 */
  .container {
    display: flex;
    flex-direction: column;
    flex: 1; /* 让容器填充 main 的全部空间，配合 Footer margin-top: auto */
    /* 移除固定min-height，让JavaScript动态处理布局 */
  }

  .category-header {
    margin: var(--space-8) 0;
    padding-bottom: var(--space-4);
    border-bottom: 1px solid var(--color-border);
    flex-shrink: 0; /* 防止头部区域被压缩 */
  }
  
  .category-title {
    font-size: 2.5rem;
    margin-bottom: var(--space-2);
    position: relative;
    display: inline-block;
  }
  
  .category-title::after {
    content: '';
    position: absolute;
    bottom: -8px;
    left: 0;
    width: 60px;
    height: 4px;
    background-color: var(--color-primary);
  }
  
  .category-description {
    color: var(--color-text-light);
    font-size: 1.125rem;
    max-width: 800px;
    margin-top: var(--space-4);
  }
  
  .articles-list {
    display: flex;
    flex-direction: column;
    gap: var(--space-8);
    margin-top: var(--space-6);
    width: 100%;
    flex: 1; /* 关键：让文章列表区域填充剩余空间 */
    /* 移除固定min-height，让JavaScript动态处理sticky footer */
  }

  /* 简化：只设置当前页面的特定样式 */
  .articles-list {
    flex: 1; /* 关键：让文章列表填充剩余空间 */
  }

  :global(#categoryArticlesList .large-article-card) {
    background: var(--color-background);
    border-radius: var(--radius-lg);
    overflow: visible;
    box-shadow: var(--shadow-sm);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    border: 1px solid var(--color-border);
  }

  :global(#categoryArticlesList .large-article-card:hover) {
    transform: translateY(-4px);
    box-shadow: var(--shadow-lg);
  }

  :global(#categoryArticlesList .article-image-container) {
    width: 100%;
    aspect-ratio: 16 / 9;
    overflow: hidden;
    position: relative;
    border-radius: var(--radius-lg) var(--radius-lg) 0 0;
  }

  :global(#categoryArticlesList .article-image) {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.3s ease;
    display: block;
  }

  :global(#categoryArticlesList .large-article-card:hover .article-image) {
    transform: scale(1.05);
  }

  :global(#categoryArticlesList .article-content) {
    padding: var(--space-6);
  }

  :global(#categoryArticlesList .article-meta) {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-4);
    font-size: 0.875rem;
  }

  :global(#categoryArticlesList .publish-date) {
    color: var(--color-text-light);
  }

  :global(#categoryArticlesList .article-title) {
    font-size: 1.75rem;
    font-weight: 700;
    line-height: 1.3;
    margin-bottom: var(--space-4);
  }

  :global(#categoryArticlesList .article-title a) {
    color: var(--color-text);
    text-decoration: none;
    transition: color 0.3s ease;
  }

  :global(#categoryArticlesList .article-title a:hover) {
    color: var(--color-primary);
  }

  :global(#categoryArticlesList .article-excerpt) {
    font-size: 1.125rem;
    line-height: 1.6;
    color: var(--color-text-light);
    margin-bottom: var(--space-6);
  }

  :global(#categoryArticlesList .article-footer) {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-top: var(--space-4);
    border-top: 1px solid var(--color-border);
  }

  :global(#categoryArticlesList .author) {
    font-weight: 500;
    color: var(--color-text-light);
  }

  :global(#categoryArticlesList .read-more-btn) {
    display: flex;
    align-items: center;
    gap: var(--space-1);
    color: var(--color-primary);
    font-weight: 500;
    text-decoration: none;
    transition: gap var(--transition);
    font-size: 0.875rem;
  }

  :global(#categoryArticlesList .read-more-btn:hover) {
    gap: var(--space-2);
  }

  :global(#categoryArticlesList .no-articles) {
    text-align: center;
    padding: var(--space-8);
    color: var(--color-text-light);
    font-size: 1.125rem;
  }
  
  @media (max-width: 768px) {
    .container {
      flex: 1; /* 移动端保持一致的 flex 设置 */
      /* 移除 min-height 设置，让内容自然扩展，避免子滚动条 */
    }
    
    .category-header {
      margin: var(--space-6) 0; /* 移动端减少间距 */
    }
    
    .category-title {
      font-size: 2rem;
    }
    
    .articles-list {
      /* 动态计算最小高度，由JavaScript设置 */
    }
    
    :global(#categoryArticlesList .article-title) {
      font-size: 1.5rem;
    }
    
    :global(#categoryArticlesList .article-excerpt) {
      font-size: 1rem;
    }
    
    :global(#categoryArticlesList .article-footer) {
      flex-direction: column;
      align-items: flex-start;
      gap: var(--space-3);
    }
    
    :global(#categoryArticlesList .read-more-btn) {
      align-self: flex-start;
    }
  }
</style>

<script>
  // Smart client-side update: only update if localStorage has more articles than SSR
  document.addEventListener('DOMContentLoaded', async function() {
    const categoryArticlesList = document.getElementById('categoryArticlesList');
    if (!categoryArticlesList) return;

    // Get current category from URL
    const pathParts = window.location.pathname.split('/');
    const currentCategory = pathParts[pathParts.length - 1];
    
    // Count current articles on page
    const currentArticleCount = categoryArticlesList.querySelectorAll('.large-article-card').length;
    
    // Smart caching: Check cache first, then API for latest articles
    try {
      // Cache configuration
      const cacheKey = 'category_articles_cache';
      const cacheTimeKey = 'category_articles_cache_time';
      const CACHE_DURATION = 30000; // 30 seconds cache
      
      const cachedData = localStorage.getItem(cacheKey);
      const cacheTime = localStorage.getItem(cacheTimeKey);
      const now = Date.now();
      
      let allArticles = null;
      
      // Check if we have valid cached data
      if (cachedData && cacheTime && (now - parseInt(cacheTime)) < CACHE_DURATION) {
        console.log('🚀 Using cached articles data - instant load!');
        allArticles = JSON.parse(cachedData);
      } else {
        console.log('📡 Fetching fresh articles data from API...');
        
        // Create abort controller for request timeout
        const controller = new AbortController();
        const timeoutId = setTimeout(() => {
          controller.abort();
          console.warn('⏰ API request timed out after 8 seconds');
        }, 8000); // 8 second timeout
        
        try {
          const response = await fetch('/api/articles', {
            signal: controller.signal
          });
          clearTimeout(timeoutId);
          
          if (response.ok) {
            const data = await response.json();
            // 🚀 处理新的API响应格式
            allArticles = data.articles || (Array.isArray(data) ? data : []);
            // Cache the fresh data
            localStorage.setItem(cacheKey, JSON.stringify(allArticles));
            localStorage.setItem(cacheTimeKey, now.toString());
            console.log('✅ Fresh data fetched and cached');
          } else {
            throw new Error(`API responded with status: ${response.status}`);
          }
        } catch (fetchError) {
          clearTimeout(timeoutId);
          throw fetchError;
        }
      }
      
      if (allArticles && Array.isArray(allArticles)) {
        const categoryArticles = allArticles
          .filter((article: any) => article.category === currentCategory)
          .sort((a: any, b: any) => new Date(b.publishDate).getTime() - new Date(a.publishDate).getTime());
        
        // Only update if we have more articles than what's currently displayed
        if (categoryArticles.length > currentArticleCount) {
          console.log(`📰 Found ${categoryArticles.length - currentArticleCount} new articles, updating page...`);
          updateCategoryArticles(categoryArticles);
        } else {
          console.log(`✓ Articles count (${categoryArticles.length}) matches current display (${currentArticleCount})`);
        }
      }
    } catch (error) {
      console.error('❌ Error fetching articles from API:', error);
      // Enhanced fallback strategy
      try {
        // Try legacy localStorage first
        const storedArticles = localStorage.getItem('imacx_articles');
        if (storedArticles) {
          console.log('🔄 Using fallback: legacy localStorage data');
          const parsedArticles = JSON.parse(storedArticles);
          // 🚀 确保数据是数组格式
          const articlesArray = Array.isArray(parsedArticles) ? parsedArticles : (parsedArticles.articles || []);
          const categoryArticles = articlesArray
            .filter((article: any) => article.category === currentCategory)
            .sort((a: any, b: any) => new Date(b.publishDate).getTime() - new Date(a.publishDate).getTime());
          
          if (categoryArticles.length > currentArticleCount) {
            console.log(`📋 Fallback: Found ${categoryArticles.length - currentArticleCount} new articles from localStorage`);
            updateCategoryArticles(categoryArticles);
          }
        } else {
          console.warn('⚠️ No fallback data available, keeping current content');
        }
      } catch (fallbackError) {
        console.error('💥 All fallback strategies failed:', fallbackError);
      }
    }
  });

  function updateCategoryArticles(articles: any[]) {
    const categoryArticlesList = document.getElementById('categoryArticlesList');
    if (!categoryArticlesList) return;

    // Generate new HTML for all articles
    const articlesHTML = articles.map((article: any) => `
      <div class="large-article-card">
        <div class="article-image-container">
          <img data-src="${article.image}" src="/images/placeholder.svg" alt="${article.title}" class="article-image lazy" loading="lazy" width="800" height="450" onerror="this.onerror=null; this.src='/images/placeholder.svg'; this.classList.add('error');">
        </div>
        
        <div class="article-content">
          <div class="article-meta">
            <a href="/category/${article.category}" class="category-tag ${article.category}">
              ${article.category === 'TodayNews' ? 'Today News' : 'Past News'}
            </a>
            <span class="publish-date">${formatDate(article.publishDate)}</span>
          </div>
          
          <h2 class="article-title">
            <a href="/article/${article.slug}">${article.title}</a>
          </h2>
          
          <p class="article-excerpt">${article.excerpt}</p>
          
          <div class="article-footer">
            <span class="author">By ${article.author}</span>
            <a href="/article/${article.slug}" class="read-more-btn">
              Read more
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="5" y1="12" x2="19" y2="12"></line>
                <polyline points="12 5 19 12 12 19"></polyline>
              </svg>
            </a>
          </div>
        </div>
      </div>
    `).join('');

    // Update content smoothly
    categoryArticlesList.innerHTML = articlesHTML;
  }

  function formatDate(dateString: string) {
    const date = new Date(dateString);
    return date.toLocaleDateString('en-US', { 
      year: 'numeric', 
      month: 'short', 
      day: 'numeric' 
    });
  }

  // Debounced update mechanism to prevent frequent API calls
  let updateTimeout: NodeJS.Timeout;
  function debouncedUpdate() {
    clearTimeout(updateTimeout);
    updateTimeout = setTimeout(() => {
      // Clear cache to force fresh data
      localStorage.removeItem('category_articles_cache');
      localStorage.removeItem('category_articles_cache_time');
      console.log('🔄 Cache cleared, reloading page...');
      location.reload();
    }, 1000); // 1 second debounce
  }

  // Page visibility API - only update when page is visible
  document.addEventListener('visibilitychange', function() {
    if (document.visibilityState === 'visible') {
      console.log('👁️ Page became visible, checking for updates...');
      debouncedUpdate();
    }
  });

  // Listen for article updates from Admin Manager
  window.addEventListener('articlePublished', () => {
    console.log('📢 Article published event received');
    debouncedUpdate();
  });

  window.addEventListener('articleUpdated', () => {
    console.log('📢 Article updated event received');
    debouncedUpdate();
  });

  // Listen for logout events to clear cache
  window.addEventListener('userLoggedOut', () => {
    console.log('🚪 User logged out, clearing cache...');
    localStorage.removeItem('category_articles_cache');
    localStorage.removeItem('category_articles_cache_time');
  });
</script>

<!-- 智能自动Footer位置调节 -->
<script is:inline>
document.addEventListener('DOMContentLoaded', function() {
  console.log('🚀 启动智能Footer自动定位系统...');
  
  // 添加全局防抖机制，避免函数被频繁调用
  let footerPositionTimeout;
  function autoPositionFooter() {
    clearTimeout(footerPositionTimeout);
    footerPositionTimeout = setTimeout(function() {
      // 获取关键元素
      const footer = document.querySelector('.site-footer');
      const articlesList = document.querySelector('.articles-list');
      const articles = document.querySelectorAll('.articles-list .large-article-card');
      
      if (!footer || !articlesList || articles.length === 0) {
        console.warn('❌ 找不到必要元素:', { footer: !!footer, articlesList: !!articlesList, articles: articles.length });
        return;
      }
      
      console.log('📊 找到', articles.length, '篇文章');
      
      // 添加运行标记，防止重复执行
      if (footer.dataset.positioning === 'true') {
        console.log('🔄 Footer正在定位中，跳过本次执行');
        return;
      }
      footer.dataset.positioning = 'true';
    
    // 🎯 动态计算移动端articles-list最小高度
    if (window.innerWidth <= 768) {
      // 计算所有文章的总高度
      let totalArticlesHeight = 0;
      articles.forEach(article => {
        totalArticlesHeight += article.offsetHeight;
      });
      
      // 加上文章间的间距 (articles.length - 1) * gap
      const articleGap = 32; // var(--space-8) ≈ 32px
      const totalGapHeight = (articles.length - 1) * articleGap;
      
      // 计算动态最小高度：文章总高度 + 间距 + 额外缓冲
      const dynamicMinHeight = totalArticlesHeight + totalGapHeight + 120; // 移动端恢复缓冲到80px
      
      // 设置动态最小高度
      articlesList.style.minHeight = dynamicMinHeight + 'px';
      
      console.log('📱 移动端动态设置:');
      console.log('  文章总高度:', totalArticlesHeight, 'px');
      console.log('  间距总高度:', totalGapHeight, 'px');
      console.log('  动态最小高度:', dynamicMinHeight, 'px');
    } else {
      // 桌面端清除最小高度限制
      articlesList.style.minHeight = '';
    }
    
    // 重置Footer的margin-top，让我们重新计算
    footer.style.marginTop = '0px';
    footer.style.position = 'relative';
    footer.style.clear = 'both';
    footer.style.display = 'block';
    
    // 等待样式重置完成，然后计算位置
    setTimeout(function() {
      // 获取最后一篇文章的位置
      const lastArticle = articles[articles.length - 1];
      const lastArticleRect = lastArticle.getBoundingClientRect();
      const currentScrollY = window.scrollY;
      
      // 计算最后一篇文章在文档中的绝对位置
      const lastArticleBottom = lastArticleRect.bottom + currentScrollY;
      
      // 获取文章列表容器的底部位置
      const articlesListRect = articlesList.getBoundingClientRect();
      const articlesListBottom = articlesListRect.bottom + currentScrollY;
      
      // 获取Footer当前的位置
      const footerRect = footer.getBoundingClientRect();
      const footerTop = footerRect.top + currentScrollY;
      
      console.log('📏 位置分析:');
      console.log('  最后文章底部:', Math.round(lastArticleBottom), 'px');
      console.log('  文章列表底部:', Math.round(articlesListBottom), 'px');
      console.log('  Footer当前顶部:', Math.round(footerTop), 'px');
      
      // 计算理想的Footer位置（移动端和桌面端使用不同距离）
      const isMobile = window.innerWidth <= 768;
      const footerGap = isMobile ? -60 : 60; // 移动端10px，桌面端60px
      console.log(`📱 设备检测: ${isMobile ? '移动端' : '桌面端'} (宽度: ${window.innerWidth}px, 间距: ${footerGap}px)`);
      const idealFooterTop = Math.max(lastArticleBottom, articlesListBottom) + footerGap;
      
      // 计算需要的margin-top
      const requiredMarginTop = Math.max(0, idealFooterTop - footerTop);
      
      console.log('🎯 计算结果:');
      console.log('  理想Footer位置:', Math.round(idealFooterTop), 'px');
      console.log('  需要的margin-top:', Math.round(requiredMarginTop), 'px');
      
      // 应用计算出的间距
      if (requiredMarginTop > 0) {
        footer.style.marginTop = Math.round(requiredMarginTop) + 'px';
        console.log(`✅ Footer已自动调整到最后文章下方${footerGap}px`);
      } else {
        footer.style.marginTop = footerGap + 'px'; // 使用相应的最小间距
        console.log(`✅ Footer使用最小间距${footerGap}px`);
      }
      
      // 验证最终位置
      setTimeout(function() {
        const finalFooterRect = footer.getBoundingClientRect();
        const finalFooterTop = finalFooterRect.top + window.scrollY;
        const finalGap = finalFooterTop - Math.max(lastArticleBottom, articlesListBottom);
        
        console.log('🔍 最终验证:');
        console.log('  Footer最终位置:', Math.round(finalFooterTop), 'px');
        console.log('  与最后文章间距:', Math.round(finalGap), 'px');
        
        // 根据移动端/桌面端设置不同的验证标准
        const minGap = window.innerWidth <= 768 ? 5 : 40; // 移动端最小5px，桌面端40px
        const maxGap = window.innerWidth <= 768 ? 20 : 100; // 移动端最大20px，桌面端100px
        
        if (finalGap >= minGap && finalGap <= maxGap) {
          console.log('🎉 完美！Footer位置自动调整成功');
        } else if (finalGap >= 0) {
          console.log('✅ Footer位置正常，间距稍有偏差');
        } else {
          console.log('⚠️ Footer位置可能有重叠，需要调整');
        }
        
        // 清除定位标记
        footer.dataset.positioning = 'false';
      }, 100);
      
    }, 100);
    }, 150); // 主防抖延迟150ms
  }
  
  // 页面加载完成后执行
  autoPositionFooter();
  
  // 监听窗口大小变化，重新调整（优化防抖，避免移动端滚动时的闪动）
  let resizeTimeout;
  let lastWindowWidth = window.innerWidth;
  let lastWindowHeight = window.innerHeight;
  
  window.addEventListener('resize', function() {
    clearTimeout(resizeTimeout);
    resizeTimeout = setTimeout(function() {
      const currentWidth = window.innerWidth;
      const currentHeight = window.innerHeight;
      
      // 只有在宽度或高度显著变化时才重新定位（避免移动端滚动时地址栏引起的小幅变化）
      const widthChange = Math.abs(currentWidth - lastWindowWidth);
      const heightChange = Math.abs(currentHeight - lastWindowHeight);
      
      if (widthChange > 50 || heightChange > 100) {
        console.log('📐 窗口大小显著改变，重新调整Footer位置...');
        console.log(`  宽度变化: ${widthChange}px, 高度变化: ${heightChange}px`);
        lastWindowWidth = currentWidth;
        lastWindowHeight = currentHeight;
        autoPositionFooter();
      } else {
        console.log('📱 忽略小幅resize（可能是移动端滚动引起）');
      }
    }, 500); // 增加防抖时间到500ms
  });
  
  // 监听图片加载完成，重新调整（因为图片加载可能改变文章高度）
  const images = document.querySelectorAll('.articles-list img');
  let loadedImages = 0;
  const totalImages = images.length;
  
  if (totalImages > 0) {
    images.forEach(function(img) {
      if (img.complete) {
        loadedImages++;
      } else {
        img.addEventListener('load', function() {
          loadedImages++;
          if (loadedImages === totalImages) {
            console.log('🖼️ 所有图片加载完成，重新调整Footer位置...');
            setTimeout(autoPositionFooter, 200);
          }
        });
        
        img.addEventListener('error', function() {
          loadedImages++;
          if (loadedImages === totalImages) {
            console.log('🖼️ 图片加载完成（含错误），重新调整Footer位置...');
            setTimeout(autoPositionFooter, 200);
          }
        });
      }
    });
    
    // 如果所有图片都已经加载完成
    if (loadedImages === totalImages) {
      console.log('🖼️ 图片已预加载，延迟调整Footer位置...');
      setTimeout(autoPositionFooter, 500);
    }
  }
  
  console.log('🎯 智能Footer定位系统已启动');
});
</script>