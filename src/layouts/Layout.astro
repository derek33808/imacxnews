---
import Header from '../components/global/Header.astro';
import Footer from '../components/global/Footer.astro';
// import LoginModal from '../components/global/LoginModal.astro'; // å·²æ›¿æ¢ä¸ºUserLoginModal
import AdminArticleManager from '../components/global/AdminArticleManager.astro';
import UserRegisterModal from '../components/global/UserRegisterModal.astro';
import UserLoginModal from '../components/global/UserLoginModal.astro';
import UserProfileModal from '../components/global/UserProfileModal.astro';
import AdminUsersModal from '../components/global/AdminUsersModal.astro';
import '../styles/global.css';

interface Props {
  title?: string;
  description?: string;
}

const { title = 'IMACXNews', description = 'Your trusted source for breaking news from Avenues The World School' } = Astro.props;
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="generator" content={Astro.generator} />
    <meta name="description" content={description} />
    <!-- Content Security Policy for better security -->
    {import.meta.env.DEV ? (
      <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' 'wasm-unsafe-eval' chrome-extension: moz-extension: safari-extension:; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; img-src 'self' data: https: blob:; media-src 'self' https: blob:; frame-src 'self' https://www.youtube.com https://www.youtube-nocookie.com https://player.vimeo.com; child-src 'self' https://www.youtube.com https://www.youtube-nocookie.com https://player.vimeo.com; connect-src 'self' https: wss: ws: localhost:*; font-src 'self' data: https://fonts.gstatic.com; object-src 'none'; base-uri 'self';" />
    ) : (
      <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' 'wasm-unsafe-eval'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; img-src 'self' data: https: blob:; media-src 'self' https: blob:; frame-src 'self' https://www.youtube.com https://www.youtube-nocookie.com https://player.vimeo.com; child-src 'self' https://www.youtube.com https://www.youtube-nocookie.com https://player.vimeo.com; connect-src 'self' https: wss:; font-src 'self' data: https://fonts.gstatic.com; object-src 'none'; base-uri 'self';" />
    )}
    <title>{title}</title>
    <style>
      .app-layout {
        min-height: 100vh; /* æœ€å°é«˜åº¦ï¼Œé¿å…å¼ºåˆ¶é™åˆ¶å†…å®¹ */
        display: flex;
        flex-direction: column;
        width: 100%;
        overflow: visible; /* ä½¿ç”¨é¡µé¢è‡ªèº«æ»šåŠ¨ï¼Œé¿å…å­æ»šåŠ¨å®¹å™¨ */
        flex: 1; /* ç¡®ä¿app-layoutå¡«æ»¡body */
      }
      .app-layout main {
        display: flex; /* è®© main æˆä¸ºå¼¹æ€§åˆ—å®¹å™¨ */
        flex-direction: column;
        flex: 1; /* å…³é”®ï¼šè®©mainå æ®å‰©ä½™ç©ºé—´ */
        width: 100%;
        overflow: visible;
      }
    </style>
  </head>
  <body>
    <div class="app-layout">
      <Header />
      <main>
        <slot />
      </main>
      <Footer />
    </div>
    <!-- <LoginModal /> å·²æ›¿æ¢ä¸ºUserLoginModal -->
    <AdminArticleManager />
    <UserRegisterModal />
    <UserLoginModal />
    <UserProfileModal />
    <AdminUsersModal />
    
    <!-- ğŸš€ æ€§èƒ½ä¼˜åŒ–: å»¶è¿ŸåŠ è½½éå…³é”®è„šæœ¬ -->
    <script is:inline>
      // å»¶è¿ŸåŠ è½½ç®¡ç†è„šæœ¬ï¼Œä»…åœ¨éœ€è¦æ—¶åŠ è½½
      function loadAdminScripts() {
        if (window.adminScriptsLoaded) return;
        window.adminScriptsLoaded = true;
        
        const scripts = [
          '/scripts/admin-manager.js',
          '/scripts/debug-utils.js',
          '/scripts/cache-cleaner.js'
        ];
        
        scripts.forEach((src, index) => {
          setTimeout(() => {
            const script = document.createElement('script');
            script.src = src;
            script.async = true;
            script.onerror = () => console.warn(`Failed to load: ${src}`);
            document.head.appendChild(script);
          }, index * 100); // é”™å¼€åŠ è½½æ—¶é—´
        });
      }
      
      // æ£€æŸ¥æ˜¯å¦éœ€è¦ç®¡ç†åŠŸèƒ½
      if (localStorage.getItem('user_token') || window.location.pathname.includes('/admin')) {
        loadAdminScripts();
      }
      
      // å»¶è¿ŸåŠ è½½å¹³æ»‘æ»šåŠ¨ï¼ˆéå…³é”®ï¼‰
      setTimeout(() => {
        const smoothScrollScript = document.createElement('script');
        smoothScrollScript.src = '/scripts/smooth-scroll.js';
        smoothScrollScript.async = true;
        document.head.appendChild(smoothScrollScript);
      }, 1000);
    </script>
    
    <!-- Global error handling for better UX -->
    <script is:inline>
      // Global error handling to reduce console noise
      window.addEventListener('error', function(e) {
        // Suppress common development/extension errors
        const message = e.message || '';
        const source = e.filename || '';
        
        // Filter out browser extension errors and common dev issues
        if (
          source.includes('chrome-extension://') ||
          source.includes('moz-extension://') ||
          source.includes('safari-extension://') ||
          message.includes('Non-Error promise rejection') ||
          message.includes('ResizeObserver loop limit exceeded') ||
          message.includes('401') ||
          message.includes('Unauthorized')
        ) {
          e.preventDefault();
          return false;
        }
      });
      
      // Handle unhandled promise rejections
      window.addEventListener('unhandledrejection', function(e) {
        const reason = e.reason || '';
        if (
          reason.toString().includes('chrome-extension') ||
          reason.toString().includes('moz-extension') ||
          reason.toString().includes('safari-extension') ||
          reason.toString().includes('401') ||
          reason.toString().includes('Unauthorized')
        ) {
          e.preventDefault();
          return false;
        }
      });
      
      // Override console.error for 401 errors
      const originalConsoleError = console.error;
      console.error = function(...args) {
        const message = args.join(' ');
        if (message.includes('401') || message.includes('Unauthorized')) {
          // Silently ignore 401 errors
          return;
        }
        originalConsoleError.apply(console, args);
      };
    </script>
    
    <!-- ğŸš€ ä¼˜åŒ–åçš„å›¾ç‰‡å¤„ç†è„šæœ¬ -->
    <script is:inline>
      // è½»é‡çº§å›¾ç‰‡ä¼˜åŒ–å’Œé”™è¯¯å¤„ç†
      (function() {
        function handleImageErrors() {
          const images = document.querySelectorAll('img:not([data-optimized])');
          images.forEach(img => {
            img.dataset.optimized = 'true';
            
            // ç®€åŒ–çš„é”™è¯¯å¤„ç†
            if (!img.onerror) {
              img.onerror = () => {
                img.src = '/images/placeholder.svg';
                img.classList.add('error');
              };
            }
          });
        }
        
        // å»¶è¿Ÿæ‰§è¡Œå›¾ç‰‡ä¼˜åŒ–ï¼Œé¿å…é˜»å¡å…³é”®æ¸²æŸ“
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', () => {
            setTimeout(handleImageErrors, 100);
          });
        } else {
          setTimeout(handleImageErrors, 100);
        }
      })();
    </script>
    <!-- ğŸš€ ä¼˜åŒ–åçš„æ‡’åŠ è½½è„šæœ¬ -->
    <script is:inline>
      // è½»é‡çº§æ‡’åŠ è½½å®ç°
      function initLazyLoading() {
        if ('IntersectionObserver' in window) {
          const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
              if (entry.isIntersecting) {
                const img = entry.target;
                if (img.dataset.src) {
                  img.src = img.dataset.src;
                  img.classList.remove('lazy');
                  observer.unobserve(img);
                }
              }
            });
          }, { rootMargin: '50px' });
          
          // è§‚å¯Ÿç°æœ‰å›¾ç‰‡
          document.querySelectorAll('img[data-src]').forEach(img => {
            observer.observe(img);
          });
          
          // å»¶è¿Ÿæ³¨å†ŒService Worker
          setTimeout(() => {
            if ('serviceWorker' in navigator) {
              navigator.serviceWorker.register('/service-worker.js').catch(() => {});
            }
          }, 2000);
        } else {
          // é™çº§å¤„ç†
          document.querySelectorAll('img[data-src]').forEach(img => {
            img.src = img.dataset.src;
            img.classList.remove('lazy');
          });
        }
      }
      
      // å»¶è¿Ÿåˆå§‹åŒ–æ‡’åŠ è½½
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
          setTimeout(initLazyLoading, 200);
        });
      } else {
        setTimeout(initLazyLoading, 200);
      }
    </script>
  </body>
</html>