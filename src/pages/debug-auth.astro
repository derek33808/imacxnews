---
// ä¸´æ—¶è°ƒè¯•é¡µé¢ - ç”Ÿäº§ç¯å¢ƒä¸­åº”è¯¥åˆ é™¤
export const prerender = false;
---

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç”¨æˆ·è®¤è¯è°ƒè¯•å·¥å…·</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .section {
      margin-bottom: 40px;
      padding: 20px;
      border: 1px solid #e5e5e5;
      border-radius: 8px;
    }
    .section h2 {
      margin-top: 0;
      color: #333;
    }
    .user-info {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 6px;
      margin: 10px 0;
      border-left: 4px solid #007bff;
    }
    .form-group {
      margin-bottom: 15px;
    }
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
    }
    .form-group input {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    .btn {
      background: #007bff;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    .btn:hover {
      background: #0056b3;
    }
    .btn-danger {
      background: #dc3545;
    }
    .btn-danger:hover {
      background: #c82333;
    }
    .message {
      padding: 10px;
      border-radius: 4px;
      margin: 10px 0;
    }
    .success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .warning {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
      padding: 15px;
      margin: 20px 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ”§ ç”¨æˆ·è®¤è¯è°ƒè¯•å·¥å…·</h1>
    
    <div class="warning">
      âš ï¸ <strong>æ³¨æ„ï¼š</strong>è¿™æ˜¯ä¸€ä¸ªä¸´æ—¶è°ƒè¯•å·¥å…·ï¼Œä»…ç”¨äºå¼€å‘è°ƒè¯•ã€‚ç”Ÿäº§ç¯å¢ƒä¸­åº”åˆ é™¤æ­¤é¡µé¢ã€‚
    </div>

    <div class="section">
      <h2>ğŸ“Š æŸ¥çœ‹å·²æ³¨å†Œç”¨æˆ·</h2>
      <button class="btn" onclick="loadUsers()">åŠ è½½ç”¨æˆ·åˆ—è¡¨</button>
      <div id="usersList"></div>
    </div>

    <div class="section">
      <h2>ğŸ”‘ é‡ç½®ç”¨æˆ·å¯†ç </h2>
      <div class="form-group">
        <label>ç”¨æˆ·åæˆ–é‚®ç®±ï¼š</label>
        <input type="text" id="resetIdentifier" placeholder="è¾“å…¥ç”¨æˆ·åæˆ–é‚®ç®±åœ°å€">
      </div>
      <div class="form-group">
        <label>æ–°å¯†ç ï¼š</label>
        <input type="password" id="newPassword" placeholder="è¾“å…¥æ–°å¯†ç ï¼ˆè‡³å°‘6ä½ï¼‰">
      </div>
      <button class="btn btn-danger" onclick="resetPassword()">é‡ç½®å¯†ç </button>
      <div id="resetMessage"></div>
    </div>

    <div class="section">
      <h2>ğŸ§ª æµ‹è¯•ç™»å½•</h2>
      <div class="form-group">
        <label>ç”¨æˆ·åæˆ–é‚®ç®±ï¼š</label>
        <input type="text" id="testIdentifier" placeholder="è¾“å…¥ç”¨æˆ·åæˆ–é‚®ç®±åœ°å€">
      </div>
      <div class="form-group">
        <label>å¯†ç ï¼š</label>
        <input type="password" id="testPassword" placeholder="è¾“å…¥å¯†ç ">
      </div>
      <button class="btn" onclick="testLogin()">æµ‹è¯•ç™»å½•</button>
      <div id="testMessage"></div>
    </div>

    <div class="section">
      <h2>ğŸ  è¿”å›ç½‘ç«™</h2>
      <p><a href="/" style="color: #007bff;">â† è¿”å›é¦–é¡µ</a></p>
    </div>
  </div>

  <script>
    // åŠ è½½ç”¨æˆ·åˆ—è¡¨
    async function loadUsers() {
      try {
        const response = await fetch('/api/debug/users');
        const data = await response.json();
        
        const container = document.getElementById('usersList');
        
        if (data.success && data.users.length > 0) {
          let html = `<div class="message success">æ‰¾åˆ° ${data.count} ä¸ªç”¨æˆ·ï¼š</div>`;
          
          data.users.forEach(user => {
            const lastLogin = user.lastLoginAt 
              ? new Date(user.lastLoginAt).toLocaleString('zh-CN')
              : 'ä»æœªç™»å½•';
              
            html += `
              <div class="user-info">
                <strong>ID:</strong> ${user.id}<br>
                <strong>ç”¨æˆ·å:</strong> ${user.username}<br>
                <strong>é‚®ç®±:</strong> ${user.email}<br>
                <strong>è§’è‰²:</strong> ${user.role}<br>
                <strong>æ˜¾ç¤ºåç§°:</strong> ${user.displayName || 'æœªè®¾ç½®'}<br>
                <strong>æ³¨å†Œæ—¶é—´:</strong> ${new Date(user.createdAt).toLocaleString('zh-CN')}<br>
                <strong>æœ€åç™»å½•:</strong> ${lastLogin}
              </div>
            `;
          });
          
          container.innerHTML = html;
        } else {
          container.innerHTML = '<div class="message error">æ²¡æœ‰æ‰¾åˆ°ç”¨æˆ·æˆ–åŠ è½½å¤±è´¥</div>';
        }
      } catch (error) {
        document.getElementById('usersList').innerHTML = 
          `<div class="message error">åŠ è½½å¤±è´¥: ${error.message}</div>`;
      }
    }

    // é‡ç½®å¯†ç 
    async function resetPassword() {
      const identifier = document.getElementById('resetIdentifier').value.trim();
      const newPassword = document.getElementById('newPassword').value.trim();
      const messageDiv = document.getElementById('resetMessage');
      
      if (!identifier || !newPassword) {
        messageDiv.innerHTML = '<div class="message error">è¯·å¡«å†™ç”¨æˆ·å/é‚®ç®±å’Œæ–°å¯†ç </div>';
        return;
      }

      if (newPassword.length < 6) {
        messageDiv.innerHTML = '<div class="message error">å¯†ç è‡³å°‘éœ€è¦6ä½å­—ç¬¦</div>';
        return;
      }

      try {
        const response = await fetch('/api/auth/reset-password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ identifier, newPassword })
        });
        
        const data = await response.json();
        
        if (data.success) {
          messageDiv.innerHTML = `
            <div class="message success">
              âœ… å¯†ç é‡ç½®æˆåŠŸï¼<br>
              ç”¨æˆ·: ${data.user.username} (${data.user.email})<br>
              ç°åœ¨å¯ä»¥ä½¿ç”¨æ–°å¯†ç ç™»å½•äº†
            </div>
          `;
          document.getElementById('resetIdentifier').value = '';
          document.getElementById('newPassword').value = '';
        } else {
          messageDiv.innerHTML = `<div class="message error">âŒ ${data.error}</div>`;
        }
      } catch (error) {
        messageDiv.innerHTML = `<div class="message error">é‡ç½®å¤±è´¥: ${error.message}</div>`;
      }
    }

    // æµ‹è¯•ç™»å½•
    async function testLogin() {
      const identifier = document.getElementById('testIdentifier').value.trim();
      const password = document.getElementById('testPassword').value.trim();
      const messageDiv = document.getElementById('testMessage');
      
      if (!identifier || !password) {
        messageDiv.innerHTML = '<div class="message error">è¯·å¡«å†™ç”¨æˆ·å/é‚®ç®±å’Œå¯†ç </div>';
        return;
      }

      try {
        const response = await fetch('/api/auth/user-login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ identifier, password })
        });
        
        const data = await response.json();
        
        if (data.success) {
          messageDiv.innerHTML = `
            <div class="message success">
              âœ… ç™»å½•æˆåŠŸï¼<br>
              ç”¨æˆ·: ${data.user.username} (${data.user.email})<br>
              è§’è‰²: ${data.user.role}
            </div>
          `;
        } else {
          messageDiv.innerHTML = `<div class="message error">âŒ ${data.error}</div>`;
        }
      } catch (error) {
        messageDiv.innerHTML = `<div class="message error">ç™»å½•æµ‹è¯•å¤±è´¥: ${error.message}</div>`;
      }
    }

    // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨åŠ è½½ç”¨æˆ·åˆ—è¡¨
    window.addEventListener('DOMContentLoaded', () => {
      loadUsers();
    });
  </script>
</body>
</html>
