---
// test-media.astro - æµ‹è¯•åª’ä½“ä¸Šä¼ åŠŸèƒ½çš„é¡µé¢
import Layout from '../layouts/Layout.astro';
import SimpleMediaUploader from '../components/ui/SimpleMediaUploader.astro';
import VideoArticleCard from '../components/ui/VideoArticleCard.astro';

// æ¨¡æ‹Ÿæ–‡ç« æ•°æ®ç”¨äºæµ‹è¯•
const testArticles = [
  {
    id: 1,
    title: "æµ‹è¯•å›¾ç‰‡æ–‡ç«  - ç¾ä¸½çš„é£æ™¯ç…§ç‰‡",
    slug: "test-image-article",
    excerpt: "è¿™æ˜¯ä¸€ç¯‡æµ‹è¯•å›¾ç‰‡æ–‡ç« ï¼Œå±•ç¤ºäº†ç¾ä¸½çš„è‡ªç„¶é£æ™¯ã€‚æ–‡ç« åŒ…å«ç²¾ç¾çš„å›¾ç‰‡å’Œè¯¦ç»†çš„æè¿°ï¼Œä¸ºè¯»è€…å¸¦æ¥è§†è§‰äº«å—ã€‚",
    category: "TodayNews",
    mediaType: "IMAGE" as const,
    image: "https://images.unsplash.com/photo-1506905925346-21bda4d32df4?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=2070&q=80",
    imageAlt: "ç¾ä¸½çš„å±±æ™¯",
    author: "å¼ ä¸‰",
    publishDate: new Date('2024-12-19'),
    featured: true,
    readingTime: 5
  },
  {
    id: 2,
    title: "æµ‹è¯•è§†é¢‘æ–‡ç«  - ç²¾å½©çš„æ•™å­¦è§†é¢‘",
    slug: "test-video-article",
    excerpt: "è¿™æ˜¯ä¸€ç¯‡åŒ…å«è§†é¢‘çš„æµ‹è¯•æ–‡ç« ã€‚è§†é¢‘å†…å®¹ä¸°å¯Œï¼ŒåŒ…å«è¯¦ç»†çš„æ•™å­¦å†…å®¹å’Œå®é™…æ¼”ç¤ºï¼Œæ˜¯å­¦ä¹ æ–°æŠ€èƒ½çš„ç»ä½³èµ„æºã€‚",
    category: "PastNews",
    mediaType: "VIDEO" as const,
    image: "https://images.unsplash.com/photo-1611532736597-de2d4265fba3?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=2074&q=80",
    imageAlt: "è§†é¢‘å°é¢",
    videoUrl: "https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4",
    videoDuration: 596, // 9åˆ†56ç§’
    author: "æå››",
    publishDate: new Date('2024-12-18'),
    featured: false,
    readingTime: 10
  },
  {
    id: 3,
    title: "å¦ä¸€ä¸ªå›¾ç‰‡æ–‡ç« æµ‹è¯•",
    slug: "another-image-test",
    excerpt: "åˆä¸€ç¯‡å›¾ç‰‡æ–‡ç« ï¼Œç”¨äºæµ‹è¯•ä¸åŒç±»å‹çš„åª’ä½“å±•ç¤ºã€‚å±•ç¤ºäº†ç³»ç»Ÿå¯¹å¤šç§åª’ä½“æ ¼å¼çš„è‰¯å¥½æ”¯æŒã€‚",
    category: "TodayNews",
    mediaType: "IMAGE" as const,
    image: "https://images.unsplash.com/photo-1441974231531-c6227db76b6e?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=2071&q=80",
    imageAlt: "æ£®æ—å°å¾„",
    author: "ç‹äº”",
    publishDate: new Date('2024-12-17'),
    featured: false,
    readingTime: 3
  }
];
---

<Layout title="åª’ä½“ä¸Šä¼ æµ‹è¯• - IMACXNews">
  <div class="test-media-page">
    <div class="container">
      <!-- é¡µé¢å¤´éƒ¨ -->
      <div class="page-header">
        <h1>ğŸ¬ åª’ä½“ä¸Šä¼ åŠŸèƒ½æµ‹è¯•</h1>
        <p class="page-description">
          æµ‹è¯•å›¾ç‰‡å’Œè§†é¢‘ä¸Šä¼ åŠŸèƒ½ï¼Œä»¥åŠåª’ä½“æ–‡ç« å±•ç¤ºç»„ä»¶ã€‚è¿™ä¸ªé¡µé¢åŒ…å«äº†å®Œæ•´çš„åª’ä½“å¤„ç†æµç¨‹æ¼”ç¤ºã€‚
        </p>
      </div>

      <!-- åŠŸèƒ½çŠ¶æ€æ£€æŸ¥ -->
      <div class="status-panel">
        <h2>ğŸ“Š åŠŸèƒ½çŠ¶æ€æ£€æŸ¥</h2>
        <div class="status-grid">
          <div class="status-item">
            <div class="status-icon">ğŸ–¼ï¸</div>
            <div class="status-info">
              <h3>å›¾ç‰‡ä¸Šä¼ </h3>
              <p>æ”¯æŒ JPG, PNG, GIF, WebP</p>
              <span class="status-badge active">å·²å¯ç”¨</span>
            </div>
          </div>
          <div class="status-item">
            <div class="status-icon">ğŸ¥</div>
            <div class="status-info">
              <h3>è§†é¢‘ä¸Šä¼ </h3>
              <p>æ”¯æŒ MP4, WebM, OGG</p>
              <span class="status-badge active">å·²å¯ç”¨</span>
            </div>
          </div>
          <div class="status-item">
            <div class="status-icon">â˜ï¸</div>
            <div class="status-info">
              <h3>äº‘å­˜å‚¨</h3>
              <p>Supabase Storage</p>
              <span class="status-badge pending">æ£€æŸ¥ä¸­</span>
            </div>
          </div>
          <div class="status-item">
            <div class="status-icon">ğŸ”’</div>
            <div class="status-info">
              <h3>æƒé™éªŒè¯</h3>
              <p>ä»…ç®¡ç†å‘˜å¯ä¸Šä¼ </p>
              <span class="status-badge active">å·²å¯ç”¨</span>
            </div>
          </div>
        </div>
      </div>

      <!-- åª’ä½“ä¸Šä¼ å™¨ -->
      <div class="uploader-section">
        <h2>ğŸ“¤ åª’ä½“ä¸Šä¼ å™¨</h2>
        <p class="section-description">
          é€‰æ‹©å›¾ç‰‡æˆ–è§†é¢‘æ–‡ä»¶è¿›è¡Œä¸Šä¼ æµ‹è¯•ã€‚æ”¯æŒæ‹–æ‹½ä¸Šä¼ ï¼Œè‡ªåŠ¨ç”Ÿæˆç¼©ç•¥å›¾å’Œé¢„è§ˆã€‚
        </p>
        <SimpleMediaUploader />
      </div>

      <!-- æµ‹è¯•APIè¿æ¥ -->
      <div class="api-test-section">
        <h2>ğŸ”Œ APIè¿æ¥æµ‹è¯•</h2>
        <div class="api-tests">
          <button id="testStorageConnection" class="test-btn">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M9 11H1v3h8v3l3-3-3-3z"/>
              <path d="M22 12h-4"/>
              <path d="M20 16v2a2 2 0 01-2 2H6a2 2 0 01-2-2V4a2 2 0 012-2h10l4 4v2"/>
            </svg>
            æµ‹è¯•å­˜å‚¨è¿æ¥
          </button>
          <button id="testUploadInfo" class="test-btn">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="10"/>
              <path d="l9 12 2 2 4-4"/>
            </svg>
            è·å–ä¸Šä¼ ä¿¡æ¯
          </button>
        </div>
        <div id="apiTestResults" class="api-results"></div>
      </div>

      <!-- æ–‡ç« å¡ç‰‡å±•ç¤º -->
      <div class="cards-section">
        <h2>ğŸ¨ æ–‡ç« å¡ç‰‡å±•ç¤º</h2>
        <p class="section-description">
          å±•ç¤ºæ”¯æŒå›¾ç‰‡å’Œè§†é¢‘çš„æ–‡ç« å¡ç‰‡ç»„ä»¶ï¼ŒåŒ…å«äº¤äº’å¼è§†é¢‘æ’­æ”¾å’Œå“åº”å¼è®¾è®¡ã€‚
        </p>
        <div class="articles-grid">
          {testArticles.map(article => (
            <VideoArticleCard {...article} />
          ))}
        </div>
      </div>

      <!-- å¼€å‘ä¿¡æ¯ -->
      <div class="dev-info">
        <h2>ğŸ”§ å¼€å‘ä¿¡æ¯</h2>
        <div class="dev-details">
          <div class="detail-group">
            <h3>æ–‡ä»¶é™åˆ¶</h3>
            <ul>
              <li>å›¾ç‰‡æœ€å¤§å¤§å°: 10MB</li>
              <li>è§†é¢‘æœ€å¤§å¤§å°: 50MB</li>
              <li>æ”¯æŒæ‹–æ‹½ä¸Šä¼ </li>
              <li>è‡ªåŠ¨ç”Ÿæˆç¼©ç•¥å›¾</li>
            </ul>
          </div>
          <div class="detail-group">
            <h3>å­˜å‚¨é…ç½®</h3>
            <ul>
              <li>å­˜å‚¨æœåŠ¡: Supabase Storage</li>
              <li>å­˜å‚¨æ¡¶: imacx-media</li>
              <li>CDNåŠ é€Ÿ: å·²å¯ç”¨</li>
              <li>å…¬å…±è®¿é—®: å·²é…ç½®</li>
            </ul>
          </div>
          <div class="detail-group">
            <h3>æŠ€æœ¯æ ˆ</h3>
            <ul>
              <li>å‰ç«¯: Astro + TypeScript</li>
              <li>ä¸Šä¼ API: Astro API Routes</li>
              <li>å­˜å‚¨: Supabase Storage</li>
              <li>æ•°æ®åº“: PostgreSQL</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>

  <style>
    .test-media-page {
      min-height: 100vh;
      background: 
        radial-gradient(circle at 25% 25%, rgba(139, 92, 246, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 75% 75%, rgba(59, 130, 246, 0.1) 0%, transparent 50%),
        linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      padding: 40px 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .page-header {
      text-align: center;
      margin-bottom: 48px;
    }

    .page-header h1 {
      font-size: 2.5rem;
      font-weight: 800;
      color: #1f2937;
      margin-bottom: 16px;
      background: linear-gradient(135deg, #8b5cf6, #3b82f6);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .page-description {
      font-size: 1.125rem;
      color: #6b7280;
      max-width: 600px;
      margin: 0 auto;
      line-height: 1.6;
    }

    .status-panel,
    .uploader-section,
    .api-test-section,
    .cards-section,
    .dev-info {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(12px);
      border-radius: 20px;
      padding: 32px;
      margin-bottom: 32px;
      border: 1px solid rgba(229, 231, 235, 0.8);
      box-shadow: 
        0 4px 16px rgba(0, 0, 0, 0.08),
        0 2px 4px rgba(0, 0, 0, 0.06);
    }

    .status-panel h2,
    .uploader-section h2,
    .api-test-section h2,
    .cards-section h2,
    .dev-info h2 {
      font-size: 1.5rem;
      font-weight: 700;
      color: #1f2937;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .section-description {
      color: #6b7280;
      margin-bottom: 24px;
      line-height: 1.6;
    }

    .status-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-top: 24px;
    }

    .status-item {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 20px;
      background: rgba(139, 92, 246, 0.05);
      border-radius: 12px;
      border: 1px solid rgba(139, 92, 246, 0.15);
    }

    .status-icon {
      font-size: 2rem;
      width: 48px;
      text-align: center;
    }

    .status-info h3 {
      margin: 0 0 4px 0;
      font-size: 1rem;
      font-weight: 600;
      color: #1f2937;
    }

    .status-info p {
      margin: 0 0 8px 0;
      font-size: 0.875rem;
      color: #6b7280;
    }

    .status-badge {
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
    }

    .status-badge.active {
      background: #d1fae5;
      color: #065f46;
    }

    .status-badge.pending {
      background: #fef3c7;
      color: #92400e;
    }

    .api-tests {
      display: flex;
      gap: 12px;
      margin-bottom: 24px;
      flex-wrap: wrap;
    }

    .test-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 20px;
      background: #8b5cf6;
      color: white;
      border: none;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
    }

    .test-btn:hover {
      background: #7c3aed;
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(139, 92, 246, 0.4);
    }

    .api-results {
      background: #f8fafc;
      border-radius: 12px;
      padding: 16px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.875rem;
      white-space: pre-wrap;
      min-height: 60px;
      border: 1px solid #e2e8f0;
    }

    .articles-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 24px;
      margin-top: 24px;
    }

    .dev-details {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 24px;
      margin-top: 24px;
    }

    .detail-group {
      background: rgba(139, 92, 246, 0.05);
      padding: 20px;
      border-radius: 12px;
      border: 1px solid rgba(139, 92, 246, 0.15);
    }

    .detail-group h3 {
      margin: 0 0 12px 0;
      font-size: 1.125rem;
      font-weight: 600;
      color: #1f2937;
    }

    .detail-group ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .detail-group li {
      padding: 6px 0;
      color: #4b5563;
      font-size: 0.875rem;
      position: relative;
      padding-left: 20px;
    }

    .detail-group li::before {
      content: 'âœ“';
      position: absolute;
      left: 0;
      color: #10b981;
      font-weight: bold;
    }

    @media (max-width: 768px) {
      .test-media-page {
        padding: 20px 10px;
      }

      .page-header h1 {
        font-size: 2rem;
      }

      .status-panel,
      .uploader-section,
      .api-test-section,
      .cards-section,
      .dev-info {
        padding: 20px;
        margin-bottom: 20px;
        border-radius: 16px;
      }

      .status-grid {
        grid-template-columns: 1fr;
        gap: 16px;
      }

      .articles-grid {
        grid-template-columns: 1fr;
        gap: 20px;
      }

      .dev-details {
        grid-template-columns: 1fr;
        gap: 16px;
      }

      .api-tests {
        flex-direction: column;
      }
    }

    @media (prefers-color-scheme: dark) {
      .test-media-page {
        background: 
          radial-gradient(circle at 25% 25%, rgba(139, 92, 246, 0.15) 0%, transparent 50%),
          radial-gradient(circle at 75% 75%, rgba(59, 130, 246, 0.15) 0%, transparent 50%),
          linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
      }

      .status-panel,
      .uploader-section,
      .api-test-section,
      .cards-section,
      .dev-info {
        background: rgba(30, 41, 59, 0.95);
        border-color: rgba(75, 85, 99, 0.8);
      }

      .page-header h1 {
        color: #f1f5f9;
      }

      .status-panel h2,
      .uploader-section h2,
      .api-test-section h2,
      .cards-section h2,
      .dev-info h2 {
        color: #f1f5f9;
      }

      .page-description,
      .section-description {
        color: #94a3b8;
      }

      .status-item {
        background: rgba(139, 92, 246, 0.1);
        border-color: rgba(139, 92, 246, 0.2);
      }

      .status-info h3 {
        color: #f1f5f9;
      }

      .status-info p {
        color: #94a3b8;
      }

      .detail-group {
        background: rgba(139, 92, 246, 0.1);
        border-color: rgba(139, 92, 246, 0.2);
      }

      .detail-group h3 {
        color: #f1f5f9;
      }

      .detail-group li {
        color: #cbd5e1;
      }

      .api-results {
        background: rgba(15, 23, 42, 0.8);
        border-color: rgba(75, 85, 99, 0.5);
        color: #e2e8f0;
      }
    }
  </style>

  <script>
    // APIæµ‹è¯•è„šæœ¬
    document.addEventListener('DOMContentLoaded', function() {
      const testStorageBtn = document.getElementById('testStorageConnection');
      const testUploadInfoBtn = document.getElementById('testUploadInfo');
      const apiResults = document.getElementById('apiTestResults');
      const storageStatusBadge = document.querySelector('.status-item:nth-child(3) .status-badge');

      // æµ‹è¯•å­˜å‚¨è¿æ¥
      testStorageBtn?.addEventListener('click', async function() {
        apiResults.textContent = 'æ­£åœ¨æµ‹è¯•å­˜å‚¨è¿æ¥...';
        testStorageBtn.disabled = true;

        try {
          const response = await fetch('/api/media/simple-upload?action=test');
          const result = await response.json();

          if (response.ok) {
            apiResults.textContent = `âœ… å­˜å‚¨è¿æ¥æˆåŠŸ!\n\n${JSON.stringify(result, null, 2)}`;
            if (storageStatusBadge) {
              storageStatusBadge.textContent = 'å·²è¿æ¥';
              storageStatusBadge.className = 'status-badge active';
            }
          } else {
            throw new Error(result.error || 'è¿æ¥å¤±è´¥');
          }
        } catch (error) {
          apiResults.textContent = `âŒ å­˜å‚¨è¿æ¥å¤±è´¥:\n\n${error.message}`;
          if (storageStatusBadge) {
            storageStatusBadge.textContent = 'è¿æ¥å¤±è´¥';
            storageStatusBadge.className = 'status-badge error';
          }
        } finally {
          testStorageBtn.disabled = false;
        }
      });

      // è·å–ä¸Šä¼ ä¿¡æ¯
      testUploadInfoBtn?.addEventListener('click', async function() {
        apiResults.textContent = 'æ­£åœ¨è·å–ä¸Šä¼ ä¿¡æ¯...';
        testUploadInfoBtn.disabled = true;

        try {
          const response = await fetch('/api/media/simple-upload?action=info');
          const result = await response.json();

          if (response.ok) {
            apiResults.textContent = `ğŸ“‹ ä¸Šä¼ é…ç½®ä¿¡æ¯:\n\n${JSON.stringify(result, null, 2)}`;
          } else {
            throw new Error(result.error || 'è·å–ä¿¡æ¯å¤±è´¥');
          }
        } catch (error) {
          apiResults.textContent = `âŒ è·å–ä¿¡æ¯å¤±è´¥:\n\n${error.message}`;
        } finally {
          testUploadInfoBtn.disabled = false;
        }
      });

      // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æµ‹è¯•å­˜å‚¨è¿æ¥
      setTimeout(() => {
        testStorageBtn?.click();
      }, 1000);
    });
  </script>
</Layout>
