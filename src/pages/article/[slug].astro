---
export const prerender = false;
import ArticleLayout from '../../layouts/ArticleLayout.astro';
import { createDatabaseConnection, withRetry } from '../../lib/database';

const { slug } = Astro.params;

// 强制从数据库获取文章，不使用静态数据回退
let article = null;

try {
  const prisma = createDatabaseConnection();
  article = await withRetry(async () => {
    return await prisma.article.findUnique({ where: { slug } });
  }, `Find article by slug: ${slug}`);
} catch (e: any) {
  console.error('数据库连接失败:', e?.message);
  throw new Error(`无法从数据库获取文章: ${e?.message}`);
}

// 如果数据库中没有找到文章，返回404
if (!article) {
  console.error(`数据库中未找到文章: ${slug}`);
  return Astro.redirect('/404');
}
---

<ArticleLayout article={article} />